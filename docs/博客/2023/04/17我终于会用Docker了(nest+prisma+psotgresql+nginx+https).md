# æˆ‘ç»ˆäºä¼šç”¨Dockeräº†(nest+prisma+psotgresql+nginx+https)

## å‰è¨€

è¿™æ¬¡è‡ªå·±æœ‰ä¸€ä¸ªNestJSåç«¯æœåŠ¡éœ€è¦è‡ªå·±éƒ¨ç½²äº†ï¼Œä¹‹å‰éƒ¨ç½²nodeæœåŠ¡å¯èƒ½æ›´å¤šæ˜¯pm2é‚£ä¸€å¥—ï¼Œè‡ªå·±çš„é¡¹ç›®å¯ä»¥å°è¯•å„ç§å„æ ·çš„æŠ€æœ¯ï¼Œæ‰€ä»¥è¿™æ¬¡å°±å°è¯•ä¸€ä¸‹æ—©å°±æƒ³ç”¨çš„dockeræ¥å®é™…éƒ¨ç½²ä¸€ä¸‹

æœ¬æ–‡ä¼šè®²ä»€ä¹ˆï¼šå¯¹äºdockerçš„ç†è§£ï¼Œdockerå¿…çŸ¥å¿…ä¼šçš„å‘½ä»¤ï¼Œä»¥åŠæœ€åæ˜¯ç¬”è€…çš„å®æˆ˜éƒ¨ç½²ï¼Œå’Œä¸€äº›è¸©å‘è®°å½•ï¼›
æœ¬æ–‡ä¸ä¼šè®²ä»€ä¹ˆï¼šdockeræ›´æ·±å±‚æ¬¡çš„åŸç†ï¼Œå³æœ¬æ–‡æ›´å¤šæ˜¯ä¸€ç¯‡åº”ç”¨æ€§æ–‡ç« ï¼Œæ¬¢è¿ç»§ç»­é˜…è¯»åç»­ç« èŠ‚ï¼›

## åŸºæœ¬æ¦‚å¿µä»‹ç»

### ç®€ä»‹

å¦‚æœæ˜¯è®¡ç®—æœºä¸“ä¸šçš„å­¦ç”Ÿï¼Œé‚£ä¹ˆæ˜¯è‚¯å®šå­¦è¿‡æ“ä½œç³»ç»Ÿçš„ï¼Œè€Œå­¦è¿™é—¨è¯¾ç¨‹æœ‰ä¸€é—¨æ“ä½œç³»ç»Ÿå®éªŒï¼Œéœ€è¦è‡ªå·±åœ¨linuxä¸Šé€šè¿‡æ¨¡æ‹Ÿå™¨å†è¿è¡Œä¸€ä¸ªéå¸¸ä½ç‰ˆæœ¬çš„linuxï¼Œç¬”è€…éšçº¦è®°å¾—å¥½åƒæ˜¯0.11é‚£ä¸ªç‰ˆæœ¬ï¼Œå› ä¸ºè¿™ä¸ªç‰ˆæœ¬ä»£ç ç›¸å¯¹æ¥è¯´éƒ½æ˜¯æ¯”è¾ƒæ ¸å¿ƒä¸»è¦çš„åŠŸèƒ½ï¼Œç”¨æ¥å­¦ä¹ æ˜¯éå¸¸ä¸é”™çš„ã€‚

åœ¨æ“ä½œç³»ç»Ÿè¿è¡Œä¸€ä¸ªå¯ä»¥è¿è¡Œå…¶ä»–ç¯å¢ƒçš„"ç³»ç»Ÿç¯å¢ƒ"ï¼Œè¿™ä¸å°±æ˜¯Dockerçš„æ¦‚å¿µå—ã€‚æˆ–è€…å¦‚æœä½ æ²¡æœ‰ä¸Šè¿°çš„ç»å†ï¼Œé‚£æ€»åœ¨æœ¬æœºè¿è¡Œè¿‡VMå§ï¼Œç”šè‡³è¯´win11ä¸­çš„wslæ€»çŸ¥é“å§ã€‚

**åŸºæœ¬æ¦‚å¿µå°±æ˜¯è¿™ä¸ªï¼šåœ¨linuxç³»ç»Ÿä¸Šè¿è¡Œä¸€ä¸ª"ç³»ç»Ÿç¯å¢ƒ"ï¼Œå®˜æ–¹å«åšå®¹å™¨ã€‚**

é‚£è¿™ä¸ªæ‰€è°“çš„"ç³»ç»Ÿç¯å¢ƒ"å¯ä»¥åšä»€ä¹ˆå‘¢ï¼Œå½“ç„¶æ˜¯è¿è¡Œä¸€äº›æˆ‘ä»¬å¸¸ç”¨çš„ä¸œè¥¿ï¼Œå¦‚nodeã€mysqlã€redisä»¥åŠæˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ç¨‹åºç­‰ã€‚

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230417094610.png)
[å›¾ç‰‡æ¥æº](https://www.docker.com/resources/what-container/)

### ä¼˜ç‚¹

å¥½ï¼Œé—®é¢˜åˆæ¥äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨è¯¥linuxç³»ç»Ÿä¸Šè¿è¡Œè¿™äº›ç¯å¢ƒï¼šè¿™ä¸ªé—®é¢˜ç”¨Dockerçš„ä¸»è¦ä¼˜åŠ¿å°±èƒ½å›ç­”ï¼š

**1ï¼‰ç®€åŒ–åº”ç”¨ç¨‹åºéƒ¨ç½²å’Œä¾èµ–ç®¡ç†**

Dockeræ˜¯å°†åº”ç”¨ç¨‹åºå’Œå…¶ä¾èµ–é¡¹æ‰“åŒ…åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œé¿å…äº†å¤æ‚çš„ä¾èµ–ç®¡ç†å’Œæ‰‹åŠ¨å®‰è£…ï¼Œå› æ­¤å¯ä»¥å¿«é€Ÿéƒ¨ç½²å’Œæ›´æ–°åº”ç”¨ç¨‹åºã€‚

æ€ä¹ˆç†è§£ï¼š

- pythonæ‰“åŒ…exeç”¨è¿‡å§ï¼šå®ƒä¼šå°†å…¶ä¾èµ–çš„æ‰€æœ‰ç¯å¢ƒä¸€èµ·æ‰“åŒ…æœ€åæˆä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå½¢æˆäº†è¿™æ ·ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜¯ä¸æ˜¯ç”¨æˆ·åªéœ€è¦åŒå‡»å°±èƒ½æ‰“å¼€ï¼Œä¸éœ€è¦åƒç¨‹åºå‘˜ä¸€æ ·å®‰è£…å„ç§å¤æ‚çš„ä¾èµ–
- å‰ç«¯çš„electronç”¨è¿‡å§ï¼šå®ƒä¹Ÿå°†åº”ç”¨ç¨‹åºä¸æµè§ˆå™¨ç¯å¢ƒæ‰“åŒ…åœ¨ä¸€èµ·äº†ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ä½ çš„åº”ç”¨ç¨‹åºäº†
- è¿™ä¹ˆç†è§£ï¼šæœ‰äº†å®ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æŠŠè¿™ä¸ª"è½¯ä»¶åŒ…"è¿›è¡Œéƒ¨ç½²ï¼Œè€Œæ²¡æœ‰å®ƒï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ°ç”¨æˆ·çš„ä¸»æœºï¼Œå»å¹²ä»€ä¹ˆ`pip install`ä¹‹ç±»çš„ï¼ŒçœŸç´¯~

**2ï¼‰è·¨å¹³å°å’Œç¯å¢ƒå¯ç§»æ¤æ€§**

Dockerå®¹å™¨å¯ä»¥åœ¨ä»»ä½•æ“ä½œç³»ç»Ÿã€äº‘å¹³å°å’Œè™šæ‹ŸåŒ–ç¯å¢ƒä¸­è¿è¡Œï¼Œä¿è¯äº†åº”ç”¨ç¨‹åºåœ¨ä¸åŒç¯å¢ƒä¸‹çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

ä¹Ÿæ˜¯ç¬¬ä¸€ç‚¹æ‰€è®²åˆ°çš„ï¼Œæ—¢ç„¶éƒ½æ‰“åŒ…æˆäº†ä¸€ä¸ªè½¯ä»¶åŒ…ï¼Œé‚£ä¹ˆå°±å¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿è¡Œåœ¨å„ä¸ªç¯å¢ƒä¹‹ä¸­äº†ï¼š

- æƒ³æƒ³Javaè™šæ‹ŸæœºJVMï¼ŒJavaåˆšå‡ºçš„æ—¶å€™ä¸»æ‰“çš„å°±æ˜¯ä¸€ä¸ªå¯ç§»æ¤æ€§ï¼Œå…¶å°±æ˜¯é€šè¿‡å…ˆç¼–è¯‘æˆå­—èŠ‚ç ï¼Œä¹Ÿå°±æ˜¯é‚£ä¸ª`.class`æ–‡ä»¶ï¼Œç„¶åè¯¥æ–‡ä»¶å°±å¯ä»¥åœ¨ä»»ä½•å®‰è£…äº†JVMçš„ç³»ç»Ÿä¸Šè¿è¡Œäº†ã€‚
- Dockerä¹Ÿæ˜¯ï¼Œåªè¦è¯¥ç¯å¢ƒå®‰è£…äº†Dockerï¼Œé‚£ä¹ˆç”±å…¶æ‰“åŒ…çš„"è½¯ä»¶åŒ…"ä¹Ÿå°±èƒ½ç›´æ¥è¿è¡Œäº†

### ä¸€äº›å…³é”®è¯åŠæ¦‚å¿µ

æƒ³å…¥é—¨æŸä¸ªé¢†åŸŸï¼Œç¬¬ä¸€æ­¥å°±æ˜¯å¾—å…ˆäº†è§£è¯¥é¢†åŸŸç‰¹æœ‰çš„å…³é”®çƒ­è¯ï¼Œä¸‹é¢æ˜¯Dockerä¸­å¸¸ç”¨çš„ä¸€äº›å…³é”®è¯åŠæ¦‚å¿µç®€ä»‹ï¼š

1.  **Dockeré•œåƒ(Image)**: Dockeré•œåƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€å¯ç§»æ¤çš„ã€è‡ªåŒ…å«çš„è½¯ä»¶åŒ…ï¼Œå…¶ä¸­åŒ…å«äº†è¿è¡ŒæŸä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶ã€é…ç½®å’Œä¾èµ–é¡¹ã€‚
2. **Dockerå®¹å™¨(Container)**: Dockerå®¹å™¨æ˜¯ç”±Dockeré•œåƒåˆ›å»ºçš„è¿è¡Œå®ä¾‹ï¼Œå®¹å™¨ä¸­åŒ…å«äº†æ‰€æœ‰è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ–‡ä»¶ã€é…ç½®å’Œä¾èµ–é¡¹ï¼Œä»¥åŠè¿è¡Œæ—¶ç¯å¢ƒã€‚

> é•œåƒä¸å®¹å™¨çš„æ¦‚å¿µå°±å’Œç¨‹åºä¸è¿›ç¨‹çš„æ¦‚å¿µæ˜¯ä¸€è‡´çš„ï¼Œä¸€ä¸ªæ˜¯ä¹è°±ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯æ­£åœ¨æ¼”å¥çš„éŸ³ä¹äº†

4. **Dockerä»“åº“(Registry)**: Dockerä»“åº“æ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å’Œå…±äº«Dockeré•œåƒçš„ä¸­å¤®å­˜å‚¨åº“ï¼ŒDocker Hubæ˜¯ä¸€ä¸ªå…¬å…±çš„Dockerä»“åº“ã€‚
5. **Dockerfile**: Dockerfileæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ç»„æŒ‡ä»¤ï¼Œç”¨äºè‡ªåŠ¨åŒ–æ„å»ºDockeré•œåƒã€‚å°±å’ŒCè¯­è¨€ä¸­çš„Makefileå·®ä¸å¤šã€‚
6. **Docker Compose**: Docker Composeæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šä¸ªDockerå®¹å™¨ç»„æˆçš„åº”ç”¨ç¨‹åºï¼Œå¹¶ç®¡ç†å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚
7. **Dockerç½‘ç»œ(Network)**: Dockerç½‘ç»œæ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šä¸ªDockerå®¹å™¨ä¹‹é—´å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œä»¥å®ç°å®¹å™¨ä¹‹é—´çš„é€šä¿¡ã€‚
8. **Dockeræ•°æ®å·(Volume)**: Dockeræ•°æ®å·æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨Dockerå®¹å™¨å’Œä¸»æœºä¹‹é—´å…±äº«æ•°æ®ã€‚
9. **Docker daemon**ï¼šæ˜¯Dockerçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¹Ÿç§°ä¸ºDockerå¼•æ“ã€‚å®ƒæ˜¯ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„åå°è¿›ç¨‹ï¼Œè´Ÿè´£ç®¡ç†Dockeré•œåƒã€å®¹å™¨ã€ç½‘ç»œå’Œå­˜å‚¨å·ç­‰èµ„æºã€‚

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230417094716.png)
[å›¾ç‰‡æ¥æº](https://algodaily.com/lessons/what-is-a-container-a-docker-tutorial)

*ç›¸å…³æ¦‚å¿µå¦‚æœä¸ç†è§£ä¹Ÿæ²¡å…³ç³»ï¼Œåç»­å®æˆ˜æ—¶çœ‹çœ‹è¿™äº›ä¸œè¥¿åˆ°åº•é•¿å•¥æ ·ï¼Œå°±è‡ªç„¶è€Œç„¶å°±æ˜ç™½äº†*

## å¸¸ç”¨å‘½ä»¤

è¿™é‡Œç®€å•ç´¢å¼•å¹¶ä»‹ç»ä¸€ä¸‹ç¬”è€…è‡ªå·±å¸¸ç”¨çš„ä¸€äº›å…³äºdockeråŠdocker-composeç›¸å…³çš„å‘½ä»¤ï¼Œå¸Œæœ›å¯¹ä½ æ‰€æœ‰å¸®åŠ©ï¼š

|å‘½ä»¤|ä½œç”¨|å¤‡æ³¨|
|-|-|-|
|`docker ps -n 5`|æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å‰5ä¸ªå®¹å™¨|æ•°å­—ä»£è¡¨å‰å‡ ä¸ªï¼Œä¹Ÿå¯ä»¥ä¸åŠ -nï¼Œå°±æ˜¯æ‰€æœ‰ï¼›å°±å’Œ`ps -ef`æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸€æ ·|
|`docker rm $(docker ps -a -q)`|åˆ é™¤æ‰€æœ‰å·²ç»åœæ­¢çš„å®¹å™¨|æ— |
|`docker tag [é•œåƒid] [æ–°é•œåƒåç§°]:[æ–°é•œåƒæ ‡ç­¾]`|æ ¹æ®idä¸ºæŸä¸ªé•œåƒæ·»åŠ åç§°åŠæ ‡ç­¾|å¶å°”é•œåƒåå­—æ˜¾ç¤º`<none>`æ—¶æå…¶æœ‰ç”¨|
|ç•¥|å®¹å™¨/é•œåƒçš„å¯¼å…¥ä¸å¯¼å‡º|[å‚è€ƒé“¾æ¥](https://zhuanlan.zhihu.com/p/619626619)|
| `docker-compose up -d`| å¯åŠ¨å¹¶åå°è¿è¡Œ|æ— |
|`docker exec -i -t containerId /bin/bash`|è¿›å…¥åˆ°å®¹å™¨å†…éƒ¨ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªbash shellï¼Œå¼€å§‹äº¤äº’å¼æ“ä½œ|CTRL+Dé€€å‡º|

Dockerä¸Docker-composeï¼šæ„å»ºé•œåƒ

|å‘½ä»¤|ä½œç”¨|å¤‡æ³¨|
|-|-|-|
|`docker build -t nest-api .`|åœ¨å½“å‰ç›®å½•`.`æ„å»ºé•œåƒï¼Œé»˜è®¤ä½¿ç”¨Dockerfileæ–‡ä»¶|-f æŒ‡å®šä»»ä¸€Dockerfileæ–‡ä»¶ï¼›-tä»£è¡¨é•œåƒå|
|`docker-compose build`|åœ¨å½“å‰ç›®å½•ï¼Œé€šè¿‡é»˜è®¤çš„docker-compose.ymlæ–‡ä»¶è¿›è¡Œæ„å»º|ç•¥|

ä¸€èˆ¬ä¸€ä¸ªDockerfileå¯¹åº”ä¸€ä¸ªå®¹å™¨ï¼Œå¦‚æœæˆ‘ä»¬è¦éƒ¨ç½²å¤šä¸ªå®¹å™¨ï¼Œå°±éœ€è¦æ¯æ¬¡è¿è¡Œå„ä¸ªä¸åŒçš„Dockerfileï¼Œä¸ºäº†ç®€åŒ–dockerçš„å¤æ‚æ“ä½œï¼Œå°±æœ‰äº†dcoekr-composeï¼Œå®ƒå°±å¯ä»¥åœ¨å…¶ymlæ–‡ä»¶ä¸Šå†™å¤šä¸ªé•œåƒè¿›è¡Œéƒ¨ç½²å®¹å™¨

è¿˜æœ‰å°±æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªshellè„šæœ¬ï¼Œåç»­ä¼šä½¿ç”¨è¯¥`setup.sh`ï¼Œä½œç”¨å°±æ˜¯æ¯æ¬¡æ›´æ–°éƒ¨ç½²æ—¶åœ¨å¯¹åº”ç›®å½•è¿è¡Œå°±å¯ä»¥äº†ï¼š

```shell
#!/usr/bin/env bash
#image_version=`date +%Y%m%d%H%M`;

# å…³é—­å®¹å™¨
docker-compose stop || true;
# åˆ é™¤å®¹å™¨
docker-compose down || true;
# æ„å»ºé•œåƒ
docker-compose build;
# å¯åŠ¨å¹¶åå°è¿è¡Œ
docker-compose up -d;
# æŸ¥çœ‹æ—¥å¿—
docker logs nodejs;
# å¯¹ç©ºé—´è¿›è¡Œè‡ªåŠ¨æ¸…ç†
docker system prune -a -f
```

## å®æˆ˜

ç°åœ¨ï¼Œä½ å·²ç»äº†è§£äº†Dockerçš„ç›¸å…³æ¦‚å¿µä»¥åŠDockerçš„ä¸€äº›å¸¸ç”¨æ“ä½œäº†ï¼Œä¸‹é¢å°±è¿›å…¥å®æˆ˜è®©ä½ ç»ƒç»ƒæ‰‹å¹¶åŠ æ·±ç†è§£ã€‚

æˆ‘çš„é¡¹ç›®æ–‡ä»¶ç›®å½•å¦‚ä¸‹ï¼š

```txt
nest-api
â”œâ”€ .dockerignore
â”œâ”€ .eslintrc.js
â”œâ”€ .github
â”‚  â””â”€ workflows
â”‚     â””â”€ ci.yml
â”œâ”€ .gitignore
â”œâ”€ .graphqlconfig
â”œâ”€ .node-version
â”œâ”€ .prettierrc.json
â”œâ”€ .vscode
â”‚  â””â”€ extensions.json
â”œâ”€ docker-compose.db.yml
â”œâ”€ docker-compose.migrate.yml
â”œâ”€ docker-compose.yml
â”œâ”€ Dockerfile
â”œâ”€ Dockerfile.alpine
â”œâ”€ LICENSE
â”œâ”€ nest-cli.json
â”œâ”€ package-lock.json
â”œâ”€ package.json
â”œâ”€ pull-env.sh
â”œâ”€ .env
â”œâ”€ README.md
â”œâ”€ run.sh
â”œâ”€ setup.sh
â”œâ”€ src[ç•¥]
ç•¥...
```

### prisma+neståº”ç”¨çš„Dockerfile

ç¼–å†™è‡ªå·±çš„NestJSåº”ç”¨éœ€è¦çš„Dockerfileï¼š

```txt
FROM node:16-alpine AS builder

# Create app directory
WORKDIR /app

# A wildcard is used to ensure both package.json AND package-lock.json are copied
COPY package*.json ./
COPY prisma ./prisma/

# Install app dependencies
RUN npm install

COPY . .

RUN npm run build

FROM node:16-alpine

WORKDIR /app

COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/dist ./dist

EXPOSE 3000
CMD [ "npm", "run", "start:prod" ]
```

è¿™äº›è‹±æ–‡å•è¯éƒ½æ˜¯ä¸€çœ‹å°±å·®ä¸å¤šæ‡‚å¾—å‘½ä»¤è¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œå…¶ä¸­`FROM node:16-alpine`ä»£è¡¨è¯¥é•œåƒç»§æ‰¿è‡ªnodeé•œåƒï¼Œæ¯•ç«Ÿæ˜¯ä¸ªnodeåº”ç”¨å˜›ï¼›`apline`ç‰ˆæœ¬æ›´åŠ è½»é‡ï¼Œæ‰“åŒ…ä½“ç§¯æ›´å°ï¼Œä¸€èˆ¬æ¥è¯´ä¸å»ç¼–å†™å“ªäº›C++æ‰©å±•éƒ½æ˜¯å¤Ÿç”¨çš„ã€‚

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230417111640.png)

[å›¾ç‰‡æ¥æº](https://juejin.cn/post/6844904006184091662#heading-6)

### neståº”ç”¨+postgresql+niginxçš„ymlé…ç½®

æ­¤æ—¶ç›¸å½“äºæˆ‘ä»¬å°±æœ‰æˆ‘ä»¬è‡ªå·±åº”ç”¨çš„é•œåƒæ–‡ä»¶äº†ï¼Œä½†å…¶ä¾èµ–çš„ç¯å¢ƒè¿˜æ²¡æœ‰ï¼Œæ¯”å¦‚postgresqlï¼›è¿˜æœ‰å°±æ˜¯æˆ‘éœ€è¦çš„nginxï¼Œè¿™äº›éƒ½æ˜¯æœ‰ç°æˆçš„ï¼Œæ‰€ä»¥å°±ä¸ç”¨è‡ªå·±æ„å»ºäº†ï¼Œç›´æ¥ä½¿ç”¨ï¼›ä½†æƒ³è¦å°†å®ƒä»¬å¼„åœ¨ä¸€èµ·ï¼Œå°±éœ€è¦ç¼–å†™`docker-compose.yml`æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š

```yaml
version: '3.8'
services:
  nest-api:
    container_name: nest-api
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - '3000:3000'
    depends_on:
      - postgres
    env_file:
      - .env

  postgres:
    image: postgres:13
    container_name: postgres
    restart: always
    ports:
      - '5432:5432'
    env_file:
      - .env
    volumes:
      - postgres:/var/lib/postgresql/data

  nginx:
    image: nginx:stable-alpine      # æŒ‡å®šæœåŠ¡é•œåƒ
    container_name: nginx    # å®¹å™¨åç§°
    restart: always                 # é‡å¯æ–¹å¼
    ports:                          # æ˜ å°„ç«¯å£
      - "80:80"
      - "443:443"
    volumes:                        # æŒ‚è½½æ•°æ®å·
      - /etc/localtime:/etc/localtime
      - /home/ubuntu/work/nginx/conf.d:/etc/nginx/conf.d
      - /home/ubuntu/work/nginx/logs:/var/log/nginx
      - /home/ubuntu/work/nginx/cert:/etc/nginx/cert
    depends_on:                     # å¯åŠ¨é¡ºåº
      - nest-api

volumes:
  postgres:
    name: nest-db

```

å…¶ä¸­`volumes`çš„æ„æ€å°±æ˜¯è®©å®¹å™¨ä¸­çš„æŸä¸ªæ–‡ä»¶ä¸æ“ä½œç³»ç»Ÿä¸­çš„æŸä¸ªæ–‡ä»¶è¿›è¡Œå¯¹åº”ï¼Œä»è€Œåšåˆ°æŒä¹…åŒ–å­˜å‚¨ã€‚

### é…ç½®niginx

ä¸Šè¿°ä¸­çš„ï¼š

```yaml
      - /home/ubuntu/work/nginx/conf.d:/etc/nginx/conf.d
      - /home/ubuntu/work/nginx/logs:/var/log/nginx
      - /home/ubuntu/work/nginx/cert:/etc/nginx/cert
```

å†’å·å‰é¢çš„è·¯å¾„æ˜¯æˆ‘è‡ªå·±åœ¨æ“ä½œç³»ç»Ÿç¯å¢ƒä¸­åˆ›å»ºçš„è·¯å¾„ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„ä¹ æƒ¯è¿›è¡Œåˆ›å»ºï¼Œç„¶åå¯¹åº”åˆ°å®¹å™¨çš„è·¯å¾„å°±å¯ä»¥äº†

**1ï¼‰conf.dé…ç½®**

```sh
vim /home/ubuntu/work/nginx/conf.d/default.conf
```

è¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```txt
server {
  listen 443 ssl http2;
  server_tokens off;

  root /var/www/html;
  index index.html index.htm;

  # ä¿®æ”¹ä¸ºè‡ªå·±çš„åŸŸå
  server_name api.example.com;

  client_max_body_size 4M;
  # sslè¯ä¹¦å­˜æ”¾ä½ç½®
  ssl_certificate /etc/nginx/cert/api.example.com.pem;
  ssl_certificate_key /etc/nginx/cert/api.example.com.key;
  ssl_session_timeout 5m;
  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;

  # è®¿é—® / è·¯å¾„æ—¶æ‰§è¡Œåå‘ä»£ç†
  location / {
    # è¿™é‡Œ nodejs æ˜¯ node å®¹å™¨å
    proxy_pass http://nest-api:3000;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    # åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡ X-Forwarded-For è·å–ç”¨æˆ·çœŸå® IP
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°
    client_max_body_size 15M;
    # ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°
    client_body_buffer_size 128k;
  }
}
server {
   listen 80;
   #è¯·å¡«å†™ç»‘å®šè¯ä¹¦çš„åŸŸå
   server_name api.example.com; 
   #æŠŠhttpçš„åŸŸåè¯·æ±‚è½¬æˆhttps
   return 301 https://$host$request_uri; 
}
```

2ï¼‰certæ–‡ä»¶å¤¹

è®°å¾—æ”¾å…¥ä½ ä¸‹è½½çš„sslè¯ä¹¦å°±å¯ä»¥äº†ã€‚

3ï¼‰logs

å¯¹åº”çš„æ—¥å¿—ï¼Œæœ‰é—®é¢˜å°±å°±`cat`ä¸€ä¸‹ï¼Œçœ‹é‡Œé¢æœ‰errorä¸

### prismaçš„ä¸€ä¸ªè¸©å‘

è¿™æ˜¯prismaéœ€è¦çš„databaseURLï¼š

```txt
DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${DB_HOST}:${DB_PORT}/${POSTGRES_DB}?schema=${DB_SCHEMA}&sslmode=prefer
```

å…¶ä¸­`DB_HOST`åœ¨nestè¿è¡Œåœ¨æœ¬åœ°çš„æ—¶å€™ï¼Œæ¯”å¦‚ä½ å¯åŠ¨äº†postgresqlï¼Œç„¶å`npm run start:dev`ï¼Œè¿™æ—¶å€™`DB_HOST=localhost`

è€Œå½“ä½ nestè¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œæ¯”å¦‚éƒ¨ç½²çš„æ—¶å€™`docker-compose up -d`ï¼Œå°±éœ€è¦æ”¹ä¸ºå¯¹åº”å®¹å™¨çš„åå­—`postgres`

æˆ‘ç¡®å®å¿˜æ”¹äº†ğŸ˜­ğŸ˜­ğŸ˜­

## æœ€å

ç¬”è€…åœ¨æœ¬æ–‡ä¸»è¦å™è¿°äº†å¦‚ä¸‹éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥å½“ä½œè‡ªæ£€æ¸…å•ï¼š

1. dockeræ˜¯ä»€ä¹ˆ
2. dockerçš„ä¼˜åŠ¿ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒ
3. dockerç›¸å…³çš„å…³é”®è¯åŠæ¦‚å¿µ
4. å¸¸ç”¨å‘½ä»¤
5. æœ€åç”¨äº†ç°åœ¨æ¯”è¾ƒæ–°çš„ä¸€äº›æŠ€æœ¯æ ˆéƒ¨ç½²å®è·µ

æœ¬æ–‡å®æˆ˜éƒ¨åˆ†æ²¡æœ‰æ¯æ­¥éƒ½æˆªå›¾æ¼”ç¤ºï¼Œå‡çš„ç†ç”±æ˜¯å› ä¸ºè‡ªå·±è¯•è¯•æ¯”å•¥éƒ½å¥½ï¼ŒçœŸå®åŸå› æ˜¯æ‡’å¾—å†å»è¿è¡Œæˆªå›¾äº†...

æœ€åå¸Œæœ›æœ¬æ–‡å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œå¦‚æœæœ¬æ–‡ä¸­ç†è§£æœ‰è¯¯æˆ–è€…æ“ä½œé…ç½®ä¸å½“ï¼Œä¹Ÿå¸Œæœ›äº’å¸®äº’åŠ©ï¼Œåœ¨è¯„è®ºåŒºä¸­å‹å–„æŒ‡å‡º...

## å‚è€ƒ

- [å‰ç«¯å…¨æ ˆä¹‹è·¯ - ç©è½¬ Docker (åŸºç¡€)](https://juejin.cn/post/7147483669299462174)
- [å¦‚ä½•é€šè¿‡Dockerfileä¼˜åŒ–Nestjsé•œåƒå¤§å°](https://juejin.cn/post/7132533610707419173)
- [ä½¿ç”¨ Jenkins + Docker + Nginx + MySQL + Redis è‡ªåŠ¨éƒ¨ç½² Node é¡¹ç›®](https://juejin.cn/post/6844904006184091662)
- [ç»™å‰ç«¯å†™çš„Docker+Node+Nginx+Mongoçš„æœ¬åœ°å¼€å‘+éƒ¨ç½²å®æˆ˜](https://juejin.cn/post/6844904004296638478)
- [ä½¿ç”¨ GitHub Actions å®Œæˆ Nest é¡¹ç›®è‡ªåŠ¨æ‰“åŒ…å¹¶å‘å¸ƒåˆ°æœåŠ¡å™¨](https://juejin.cn/post/7169485484568084510)
- [Nestjs | å®è·µï¼šå¦‚ä½•ç¼–å†™ç”Ÿäº§ç¯å¢ƒä¸‹çš„Dockerfile?](https://juejin.cn/post/7205508171523604540)
- [Nestç³»åˆ—ï¼ˆå…«ï¼‰ä¸€è·¯åå·ï¼Œæˆ‘å®ç°äº†æœ€ç®€ä¾¿çš„æ–¹å¼æ‰“åŒ…éƒ¨ç½²nestjs+prismaåº”ç”¨](https://juejin.cn/post/7175937839069134903)
- [Running docker compose up -d (strconv.Atoi: parsing "": invalid syntax)](https://github.com/docker/compose-cli/issues/1537)
- [Nginx æœåŠ¡å™¨ SSL è¯ä¹¦å®‰è£…éƒ¨ç½²](https://cloud.tencent.com/document/product/400/35244)
- [Docker Nginx é…ç½®å®‰è£… SSL è¯ä¹¦ï¼ˆæ”¯æŒ Https è®¿é—®ï¼‰](https://www.quanxiaoha.com/docker/docker-nginx-install-ssl.html)
- [Prisma Migrate: Deploy Migration with Docker](https://notiz.dev/blog/prisma-migrate-deploy-with-docker)

