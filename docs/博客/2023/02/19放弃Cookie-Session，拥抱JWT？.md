# æ”¾å¼ƒCookie-Sessionï¼Œæ‹¥æŠ±JWTï¼Ÿ

## å‰è¨€

çš®ä¸€ä¸‹ğŸ’ï¼Œåªæ˜¯è§‰å¾—è¿™ç±»æ ‡é¢˜æŒºâ€œæœ‰è¶£çš„â€ï¼Œç¤¾åŒºå¥½å¤šè¿™æ ·çš„æ ‡é¢˜ï¼š`æ”¾å¼ƒXXXï¼Œæ‹¥æŠ±XXX......`ğŸ˜¶ç”šè‡³æ›´çš®ä¸€ä¸‹è¿˜å¯ä»¥è¯•è¯•å°†`?`æ¢æˆ`!`

æ¥ä¸‹æ¥ï¼Œè¯·å¿½ç•¥æ ‡é¢˜çš„æ‰­è½¬äº‹å®ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»JWTç›¸å…³çš„çŸ¥è¯†

å¾ˆæ—©å‰å†™è¿‡ä¸€ä¸ªæœç´¢å¼•æ“demoï¼Œå…¶ä¸­çš„ç™»å½•ç³»ç»ŸåŒ…å«äº†JWTè¿™é¡¹æŠ€æœ¯ï¼ˆä»…ä½¿ç”¨ï¼Œæœªæ·±å…¥ç ”ç©¶ï¼‰ï¼Œäºæ˜¯ä¹å¿ƒä¸­åŸ‹ä¸‹äº†ä¸€ä¸ªç§å­ã€‚éšç€äº’è”ç½‘ä¸Šæ–‡ç« çš„ç†é™¶ï¼Œé€æ¸å¯¹å…¶çš„æ¢ç´¢æ¬²å¢åŠ ï¼Œæƒ³ç€æ€ä¹ˆå’Œæˆ‘ä¹‹å‰çš„ç†è§£æœ‰å‡ºå…¥ã€‚ç»ˆäºæ°´è¿‡å ¤åï¼Œæ¥ç§ç§JWTåˆ°åº•æ˜¯å•¥æ ·ï¼Œå†™ä¸‹äº†è¿™ç¯‡åšæ–‡...

## å®‰å…¨çš„è½¯ä»¶æ¶æ„

[å‡¤å‡°æ¶æ„](https://icyfenix.cn/architect-perspective/general-architecture/system-security/)åœ¨æ¶æ„å®‰å…¨æ€§è¿™ç« èŠ‚ä¸­è¿™æ ·å†™é“ï¼š

> å³ä½¿åªé™å®šåœ¨â€œè½¯ä»¶æ¶æ„è®¾è®¡â€è¿™ä¸ªè¯­å¢ƒä¸‹ï¼Œç³»ç»Ÿå®‰å…¨ä»ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ã€‚æˆ‘ä»¬è°ˆè®ºçš„è®¡ç®—æœºç³»ç»Ÿå®‰å…¨ï¼Œä¸ä»…ä»…æ˜¯æŒ‡â€œé˜²å¾¡ç³»ç»Ÿè¢«é»‘å®¢æ”»å‡»â€è¿™æ ·ç‹­éš˜çš„å®‰å…¨,ï¼Œè¿˜è‡³å°‘åº”åŒ…æ‹¬ï¼ˆä¸é™äºï¼‰ä»¥ä¸‹è¿™äº›é—®é¢˜çš„å…·ä½“è§£å†³æ–¹æ¡ˆï¼š
> 
> -   [**è®¤è¯**](https://icyfenix.cn/architect-perspective/general-architecture/system-security/authentication)ï¼ˆAuthenticationï¼‰ï¼šç³»ç»Ÿå¦‚ä½•æ­£ç¡®åˆ†è¾¨å‡ºæ“ä½œç”¨æˆ·çš„çœŸå®èº«ä»½ï¼Ÿ
> -   [**æˆæƒ**](https://icyfenix.cn/architect-perspective/general-architecture/system-security/authorization)ï¼ˆ Authorizationï¼‰ï¼šç³»ç»Ÿå¦‚ä½•æ§åˆ¶ä¸€ä¸ªç”¨æˆ·è¯¥çœ‹åˆ°å“ªäº›æ•°æ®ã€èƒ½æ“ä½œå“ªäº›åŠŸèƒ½ï¼Ÿ
> -   [**å‡­è¯**](https://icyfenix.cn/architect-perspective/general-architecture/system-security/credentials)ï¼ˆCredentialï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ä¿è¯å®ƒä¸ç”¨æˆ·ä¹‹é—´çš„æ‰¿è¯ºæ˜¯åŒæ–¹å½“æ—¶çœŸå®æ„å›¾çš„ä½“ç°ï¼Œæ˜¯å‡†ç¡®ã€å®Œæ•´ä¸”ä¸å¯æŠµèµ–çš„ï¼Ÿ
> -   [**ä¿å¯†**](https://icyfenix.cn/architect-perspective/general-architecture/system-security/confidentiality)ï¼ˆConfidentialityï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ä¿è¯æ•æ„Ÿæ•°æ®æ— æ³•è¢«åŒ…æ‹¬ç³»ç»Ÿç®¡ç†å‘˜åœ¨å†…çš„å†…å¤–éƒ¨äººå‘˜æ‰€çªƒå–ã€æ»¥ç”¨ï¼Ÿ
> -   [**ä¼ è¾“**](https://icyfenix.cn/architect-perspective/general-architecture/system-security/transport-security)ï¼ˆTransport Securityï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ä¿è¯é€šè¿‡ç½‘ç»œä¼ è¾“çš„ä¿¡æ¯æ— æ³•è¢«ç¬¬ä¸‰æ–¹çªƒå¬ã€ç¯¡æ”¹å’Œå†’å……ï¼Ÿ
> -   [**éªŒè¯**](https://icyfenix.cn/architect-perspective/general-architecture/system-security/verification)ï¼ˆVerificationï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ç¡®ä¿æäº¤åˆ°æ¯é¡¹æœåŠ¡ä¸­çš„æ•°æ®æ˜¯åˆä¹è§„åˆ™çš„ï¼Œä¸ä¼šå¯¹ç³»ç»Ÿç¨³å®šæ€§ã€æ•°æ®ä¸€è‡´æ€§ã€æ­£ç¡®æ€§äº§ç”Ÿé£é™©ï¼Ÿ

- åœ¨è¿™é‡Œï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªå¸¦æœ‰ç”¨æˆ·ç³»ç»Ÿçš„å¤§å‹è½¯ä»¶ç³»ç»Ÿï¼Œæ— è®ºå…¶ä¸­çš„ç™»å½•æ³¨å†Œæµç¨‹å¤šä¹ˆçš„å¤æ‚ï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨æ¯æ¬¡æ“ä½œèµ„æºçš„æ—¶å€™è¡¨æ˜è‡ªå·±çš„èº«ä»½ï¼Œè¿™æ ·æœåŠ¡ç«¯æ‰èƒ½è¯†åˆ«è¯¥ç”¨æˆ·ç©¶ç«Ÿæ˜¯è°ï¼›
- å½“ç„¶æ¯”è¾ƒç®€å•çš„æ–¹å¼æ˜¯æ¯æ¬¡ç”¨æˆ·éƒ½å°†è‡ªå·±çš„è´¦å·å¯†ç ä¼ é€’ï¼ŒæœåŠ¡ç«¯éªŒè¯ä¸€ä¸‹å°±çŸ¥é“äº†ä½ çš„èº«ä»½ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸€ç§æ–¹å¼ï¼Œä½†æ¥å›ä¼ è¾“è¾ƒä¸ºæ•æ„Ÿçš„ä¿¡æ¯ä¸”è®©ç”¨æˆ·é¢‘ç¹ç™»å½•å¹¶ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ï¼›
- æˆ‘ä»¬å¯èƒ½æ›´å¸Œæœ›ä¸€ç§IDï¼Œkeyï¼Œå‡­è¯ä¸€æ ·çš„äº§ç‰©ï¼Œæ—¢å¯ä»¥è¯æ˜æˆ‘ä»¬çš„èº«ä»½ï¼Œåˆä¸è‡³äºç±»ä¼¼è´¦å·å¯†ç ä¸€æ ·â€œæ‹¥æœ‰å®ƒå°±æ‹¥æœ‰å…¨ä¸–ç•Œ~â€ï¼Œæ¯”å¦‚ç›´æ¥ä¿®æ”¹å¯†ç ç­‰ç­‰

å…¶ä¸­ï¼ŒJWTå’ŒCookie-Sessionåœ¨è¿™é‡Œé¢æ‰®æ¼”çš„å°±æ˜¯ä¸€ä¸ªå‡­è¯çš„è§’è‰²ï¼Œå®ƒä»¬åªæ˜¯ä¸€ä¸ªä»¤ç‰Œï¼Œç”±ç”¨æˆ·æ‰€åœ¨ç³»ç»Ÿåˆ†å‘ï¼ŒæŒæœ‰è¿™ä¸ªä»¤ç‰Œå¯ä»¥æ‹¥æœ‰è¯¥ç”¨æˆ·èº«ä»½çš„ç‰¹å®šæƒé™ã€‚æ¯”å¦‚æ ¡å›­å­¦ç”ŸæŒæœ‰å­¦æ ¡åˆ†å‘çš„æ ¡å›­å¡ï¼Œå°±æ‹¥æœ‰äº†è¿›å‡ºæ ¡å›­çš„æƒé™ï¼Œå‡ºå…¥å¯å®¤çš„æƒé™ï¼Œé£Ÿå ‚è´­ä¹°é£Ÿç‰©çš„æƒé™ç­‰ç­‰ã€‚

## åŸºæœ¬ç™»å½•æµç¨‹

ä¸ºäº†æ›´ç›´è§‚çš„æŸ¥çœ‹å‡­è¯çš„ä½œç”¨ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸ªç®€å•çš„ç™»å½•æµç¨‹ï¼š

1. å½“ç”¨æˆ·è¯·æ±‚ç”¨æˆ·èµ„æ–™é¡µæ—¶ï¼Œå‘ç°æ²¡æœ‰ä»¤ç‰Œï¼Œä¸çŸ¥é“ä½ æ˜¯å“ªä¸ªç”¨æˆ·
2. è·³è½¬ç™»å½•é¡µï¼Œç”¨æˆ·è¾“å…¥è´¦å·å¯†ç æˆ–è€…å…¶ä»–ç™»å½•æ–¹å¼
3. æœåŠ¡ç«¯éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œå¦‚æœæˆåŠŸï¼Œè¿”å›å“åº”åˆ†å‘è¯¥ç”¨æˆ·ä¸€ä¸ªä»¤ç‰Œ
4. å‰ç«¯é¡µé¢ä»¥æŸç§æ–¹å¼ä¿å­˜è¯¥ä»¤ç‰Œ
5. æ¥ä¸‹æ¥æ¯æ¬¡è¯·æ±‚æºå¸¦è¯¥ä»¤ç‰Œï¼Œæ¯”å¦‚æˆ‘ä»¬å‡ºå…¥éƒ½è¦æºå¸¦é—¨ç¦å¡ä¸€æ ·
6. æœåŠ¡å™¨éªŒè¯è¯¥ä»¤ç‰Œï¼Œç¡®è®¤æ˜¯å¦ä¸ºæ­£ç¡®çš„èº«ä»½

å¦‚ä¸‹ç”¨ä¸€ä¸ªæ—¶åºå›¾æ¥è¡¨ç¤ºï¼š

![](https://oss.justin3go.com/blogs/%E9%82%93%E4%B8%BD%E8%BF%87%E7%A8%8B%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

è¿™ä¸ªè¿‡ç¨‹æœ‰æ‰€ç®€åŒ–ï¼Œå¹¶ä¸å¤æ‚ï¼Œå°±ä¸¤ç‚¹ï¼š

- æ²¡æœ‰ä»¤ç‰Œæ—¶ï¼Œè¾“å…¥è´¦å·å¯†ç è·å–ä»¤ç‰Œï¼Œä¿æŒç™»å½•æ€
- æœ‰ä»¤ç‰Œæ—¶ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æºå¸¦ä»¤ç‰Œè¯·æ±‚èµ„æºï¼Œè¡¨æ˜è‡ªå·±çš„èº«ä»½

## ä»¤ç‰Œæ–¹æ¡ˆæ¦‚è¿°

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä½ åº”è¯¥è‡³å°‘æ˜ç™½å‡­è¯ï¼ˆä»¤ç‰Œï¼‰æ‰®æ¼”ç€ä»€ä¹ˆæ ·çš„è§’è‰²ï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼›

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ç§ç§åºå±±çœŸé¢ç›®ï¼Œå°±ç›®å‰æ¥è¯´ï¼Œä»¤ç‰Œçš„æ–¹æ¡ˆä¸»è¦ä¹Ÿå°±åˆ†ä¸ºäº†æ ‡é¢˜ä¸­æ‰€æè¿°çš„ä¸¤ç§ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«æ˜¯ç”¨æˆ·ä¿¡æ¯çš„å­˜æ”¾ä½ç½®ä¸åŒï¼š

- Cookie-Sessionæ–¹å¼ï¼ˆå¼•ç”¨ä»¤ç‰Œï¼‰ï¼šç”¨æˆ·ä¿¡æ¯ç”±æœåŠ¡å™¨ç»Ÿä¸€ç®¡ç†ï¼Œä»¤ç‰Œä¸ºä¸€ä¸ªéšæœºå­—ç¬¦ä¸²å¯ä»¥å”¯ä¸€æŒ‡å‘è¯¦ç»†çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™ä¸ªæŒ‡å‘å…³ç³»å½“ç„¶ä¹Ÿæ˜¯ç”±æœåŠ¡å™¨ä¿ç•™
- JWTæ–¹å¼ï¼ˆè‡ªåŒ…å«ä»¤ç‰Œï¼‰ï¼šç”¨æˆ·ä¿¡æ¯ç»è¿‡å¤„ç†ç›´æ¥ä½œä¸ºä»¤ç‰Œï¼Œç›¸å½“äºç”¨æˆ·ä¿¡æ¯æ˜¯ä¿ç•™åœ¨å®¢æˆ·ç«¯çš„

> å¦‚æœè¿™é‡Œä½ å¯¹ä¸Šè¿°æè¿°ä¸€çŸ¥åŠè§£ï¼Œä¸ç”¨æ…Œå¼ ï¼Œåªéœ€æœ‰ä¸€ä¸ªå°è±¡å³å¯ï¼Œæ¥ä¸‹æ¥å±•å¼€ä»‹ç»è¿™ä¸¤ç§æ–¹å¼ï¼Œè¯·ç§»æ­¥ä¸‹ä¸€å°èŠ‚...

## Cookie-Sessionç®€è¿°

é€šè¿‡Cookie-Sessionæ–¹å¼çš„è®¤è¯æµç¨‹è¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå’Œä¸Šè¿°ä»‹ç»çš„åŸºæœ¬ç™»å½•æµç¨‹å°èŠ‚æ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡å…¶ä¸­çš„å‡­è¯å…·ä½“åŒ–äº†ï¼Œæ˜¯Cookie-Sessionæ–¹å¼ã€‚

### æè¿°

åˆšæ‰æåˆ°ï¼ŒCookie-Sessionæ˜¯å±äºå¼•ç”¨ä»¤ç‰Œï¼Œç†è§£â€œå¼•ç”¨â€è¿™ä¸ªè¯çš„æ„æ€ï¼Œå’Œæˆ‘ä»¬å¼•ç”¨å¯¹è±¡æ˜¯ä¸€ä¸ªæ„æ€ï¼Œå…¶ä¸­çš„å˜é‡ååªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒçœŸæ­£çš„å¯¹è±¡ä¿ç•™åœ¨å †æ ˆå½“ä¸­ï¼›

å›åˆ°è¿™é‡Œï¼Œè¿™ç§ä»¤ç‰Œæ–¹æ¡ˆå¯¹ç”¨æˆ·çŠ¶æ€ä¿¡æ¯çš„å­˜å‚¨æ˜¯ä¿ç•™åœ¨æœåŠ¡å™¨ä¸­ç»Ÿä¸€ç®¡ç†çš„ï¼Œå…¶ä¸­ä¼šæœ‰ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²æ¯”å¦‚å«åšSessionIdæ˜¯æŒ‡å‘å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯çš„ï¼Œè€Œåˆ†å‘ç»™ç”¨æˆ·çš„ä»¤ç‰Œå°±æ˜¯è¿™ä¸ªSessionIdã€‚

ä¹‹åç”¨æˆ·æ¯æ¬¡å‘é€è¯·æ±‚çš„æ—¶å€™æºå¸¦è¿™ä¸ªSessionIdä»¤ç‰Œï¼ŒæœåŠ¡å™¨å°±å¯ä»¥æ£€æŸ¥åˆ°è¯¥ä»¤ç‰Œå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯æ˜¯å•¥ï¼Œæ˜¯å¦æœ‰æŸäº›æ“ä½œæƒé™ï¼›æˆ–è€…æ²¡æœ‰æºå¸¦è¿™ä¸ªä»¤ç‰Œï¼Œå°±æ‰§è¡Œç›¸å…³çš„ä¿æŠ¤é€»è¾‘æˆ–è€…è·³è½¬ç™»å½•

### ä¼˜ç‚¹

> åŸºæœ¬ä¸Šç›¸å…³ä¼˜ç‚¹éƒ½æ˜¯å›´ç»•â€œå¼•ç”¨ä»¤ç‰Œâ€çš„ç‰¹æ€§--ç”¨æˆ·ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šï¼Œè¿™ä¸€ç‚¹å±•å¼€çš„ã€‚

- å¯ä»¥éå¸¸æ–¹ä¾¿çš„ç®¡ç†åœ¨çº¿ç”¨æˆ·ï¼šå› ä¸ºç”¨æˆ·ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯éƒ½æ˜¯å­˜å‚¨åœ¨æœåŠ¡å™¨çš„ï¼Œæ¯”å¦‚ç»Ÿè®¡å®æ—¶åœ¨çº¿äººæ•°ï¼Œå¼ºåˆ¶æŸäº›è¿è§„ç”¨æˆ·ä¸‹çº¿ç­‰ç­‰
- ç›¸å¯¹äºåœ¨ç½‘ç»œå’Œå®¢æˆ·ç«¯æœºå™¨ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Œä¸€ä¸ªæ²¡æœ‰ä»»ä½•å«ä¹‰çš„éšæœºå­—ç¬¦ä¸²SessionIdè¢«æ³„éœ²æ‰€é€ æˆçš„å½±å“æ›´å°

### ç¼ºç‚¹

> éšç€æ—¶ä»£çš„è¿›æ­¥ï¼Œæ¯”å¦‚ç§»åŠ¨äº’è”ç½‘æ—¶ä»£çš„åˆ°æ¥ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ä»£çš„åˆ°æ¥ç­‰ç­‰ï¼Œè¿™ç§æ–¹å¼é¢ä¸´ç€ä»¥ä¸‹ç¼ºç‚¹ï¼š

-  åªèƒ½åœ¨ web åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ APP çš„æƒ…å†µï¼Œä¸èƒ½ä½¿ç”¨ cookie çš„æƒ…å†µä¸‹å°±ä¸èƒ½ç”¨äº†ï¼›
-  å¦‚æœæ˜¯åˆ†å¸ƒå¼æœåŠ¡ï¼Œéœ€è¦è€ƒè™‘ Session åŒæ­¥é—®é¢˜ï¼Œä¸€èˆ¬åœ¨[CAP](https://en.wikipedia.org/wiki/CAP_theorem)è¿™ä¸‰è§’è¿›è¡Œæƒè¡¡ï¼Œå¦‚ä¸‹å‚è€ƒè‡ª[å‡¤å‡°æ¶æ„](https://icyfenix.cn/architect-perspective/general-architecture/system-security/credentials.html)

> -   ç‰ºç‰²é›†ç¾¤çš„ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼Œè®©å‡è¡¡å™¨é‡‡ç”¨äº²å’Œå¼çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œè­¬å¦‚æ ¹æ®ç”¨æˆ· IP æˆ–è€… Session æ¥åˆ†é…èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªç‰¹å®šç”¨æˆ·å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚éƒ½ä¸€ç›´è¢«åˆ†é…åˆ°å…¶ä¸­æŸä¸€ä¸ªèŠ‚ç‚¹æ¥æä¾›æœåŠ¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¸é‡å¤åœ°ä¿å­˜ç€ä¸€éƒ¨åˆ†ç”¨æˆ·çš„çŠ¶æ€ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹å´©æºƒäº†ï¼Œé‡Œé¢çš„ç”¨æˆ·çŠ¶æ€ä¾¿å®Œå…¨ä¸¢å¤±ã€‚
> -   ç‰ºç‰²é›†ç¾¤çš„å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ï¼Œè®©å„ä¸ªèŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨å¤åˆ¶å¼çš„ Sessionï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„ Session å˜åŠ¨éƒ½ä¼šå‘é€åˆ°ç»„æ’­åœ°å€çš„å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·æŸä¸ªèŠ‚ç‚¹å´©æºƒäº†ï¼Œä¸ä¼šä¸­æ–­éƒ½æŸä¸ªç”¨æˆ·çš„æœåŠ¡ï¼Œä½† Session ä¹‹é—´ç»„æ’­å¤åˆ¶çš„åŒæ­¥ä»£ä»·é«˜æ˜‚ï¼ŒèŠ‚ç‚¹è¶Šå¤šæ—¶ï¼ŒåŒæ­¥æˆæœ¬è¶Šé«˜ã€‚
> -   ç‰ºç‰²é›†ç¾¤çš„åˆ†åŒºå®¹å¿æ€§ï¼ˆPartition Toleranceï¼‰ï¼Œè®©æ™®é€šçš„æœåŠ¡èŠ‚ç‚¹ä¸­ä¸å†ä¿ç•™çŠ¶æ€ï¼Œå°†ä¸Šä¸‹æ–‡é›†ä¸­æ”¾åœ¨ä¸€ä¸ªæ‰€æœ‰æœåŠ¡èŠ‚ç‚¹éƒ½èƒ½è®¿é—®åˆ°çš„æ•°æ®èŠ‚ç‚¹ä¸­è¿›è¡Œå­˜å‚¨ã€‚æ­¤æ—¶çš„çŸ›ç›¾æ˜¯æ•°æ®èŠ‚ç‚¹å°±æˆä¸ºäº†å•ç‚¹ï¼Œä¸€æ—¦æ•°æ®èŠ‚ç‚¹æŸåæˆ–å‡ºç°ç½‘ç»œåˆ†åŒºï¼Œæ•´ä¸ªé›†ç¾¤éƒ½ä¸å†èƒ½æä¾›æœåŠ¡ã€‚

## JWTè¯¦è°ˆ

### è®¤è¯†ä¸€ä¸‹

æ— è®ºæ˜¯è®¤è¯†äººè¿˜æ˜¯è®¤è¯†ç‰©ï¼Œå¤–è§‚å‡ ä¹éƒ½æ˜¯æˆ‘ä»¬æœ€å¼€å§‹æ¥è§¦åˆ°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹JWTé•¿å•¥æ ·ï¼š

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230219205428.png)

å¯ä»¥çœ‹åˆ°ï¼ŒJWTåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šæ ‡å¤´ã€è´Ÿè½½ã€ç­¾åï¼›è¯¦ç»†ä»‹ç»æˆ‘è¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œå¯ä»¥å‚è€ƒ[è¿™é‡Œ](https://jwt.io/introduction) ï¼Œè¿™é‡Œä»…ç®€å•æè¿°ä¸€ä¸‹ï¼š

- æ ‡å¤´ï¼šæè¿°ç±»å‹å’ŒåŠ å¯†ç®—æ³•
- è´Ÿè½½ï¼šç»è¿‡base64ç¼–ç çš„æ•°æ®ï¼Œå¦‚ç”¨æˆ·ä¿¡æ¯
- ç­¾åï¼šç”¨äºéªŒè¯æ¶ˆæ¯æ²¡æœ‰è¢«æ›´æ”¹

æ‰€ä»¥ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒJWTé‡Œé¢ä¸­åŒ…å«äº†æ•°æ®å¦‚ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œéå‰è¿°æ–¹å¼å¼•ç”¨ä»¤ç‰Œä¸åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™ä¹Ÿæ˜¯åç»­æè¿°JWTæ˜¯å¦‚ä½•è§£å†³Cookie-Sessionæ–¹å¼ä¸­çš„ç—›ç‚¹ï¼Œä»¥åŠäº§ç”Ÿæ–°çš„é—®é¢˜çš„ä¸»è¦åŸå› ï¼Œè¯·è®°ä½è¿™ä¸€ç‚¹ã€‚

### ä¼˜ç‚¹ä»‹ç»

ä¸»è¦è§£å†³äº†ä¸Šè¿°Cookie-Sessionæ–¹å¼çš„ä¸¤ä¸ªç—›ç‚¹ï¼š

- å¹¶ä¸ç‰¹å®šä¾èµ–äºCookieæ–¹å¼å­˜å‚¨
- ç”¨æˆ·ä¿¡æ¯åŒ…å«åœ¨å®¢æˆ·æœºï¼Œåˆ†å¸ƒå¼æœåŠ¡ä¸­å¤šå°æœºå™¨éƒ½å¯ä»¥è®¤è¯†ï¼Œè®¤è¯å®ƒ

---

å…³äºè®©å¤šå°æœºå™¨éªŒè¯åˆ†å‘ä¸‹æ¥çš„JWTï¼Œè¿™é‡Œå€¼å¾—è¯¦ç»†è¯´ä¸€ä¸‹ï¼Œä¸ºäº†ä¿è¯æ‘˜è¦ä¸è¢«ä¿®æ”¹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå¯¹å…¶è¿›è¡ŒåŠ å¯†ï¼Œè€ŒåŠ å¯†ç®—æ³•å¯ä»¥åˆ†ä¸º[å¯¹ç§°åŠ å¯†](https://zh.wikipedia.org/zh-hans/%E5%B0%8D%E7%A8%B1%E5%AF%86%E9%91%B0%E5%8A%A0%E5%AF%86)ä¸[éå¯¹ç§°åŠ å¯†](https://zh.wikipedia.org/wiki/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86)ï¼š

- å¯¹ç§°åŠ å¯†å¯†é’¥ä¸€æ—¦æ³„æ¼ï¼Œä¼šè®©æ•´ä¸ªæœåŠ¡çš„åŸºç¡€è®¾æ–½é­å—å®‰å…¨å¨èƒ
- è€Œä½¿ç”¨éå¯¹ç§°åŠ å¯†æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä¸­ä¸€å°æœåŠ¡å™¨ä½œä¸ºæˆæƒæœåŠ¡å™¨ï¼Œå°±æ˜¯åˆ†å‘ä»¤ç‰Œçš„ï¼Œç”±å®ƒæŒæœ‰ç§é’¥ï¼Œè€Œå…¶ä»–æœåŠ¡å™¨æŒæœ‰å…¬é’¥ï¼Œè¿™æ ·æ‰€æœ‰æœåŠ¡å™¨éƒ½å¯ä»¥éªŒè¯è¯·æ±‚ä¼ é€’è¿‡æ¥çš„ä»¤ç‰Œï¼Œè€Œæœ€é‡è¦çš„ç§é’¥ä¹Ÿä»…ç”±ä¸€å°æœåŠ¡å™¨æŒæœ‰

è¿™é‡Œæåˆ°åŠ å¯†ï¼Œè¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼šJWTä¸­åŒ…å«çš„ä¿¡æ¯(payload)å¹¶ä¸æ˜¯åŠ å¯†çš„ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿ç½‘ç»œä¼ è¾“è¿›è¡Œäº†Base64ç¼–ç ã€‚

ä¸Šè¿°åŠ å¯†çš„æ˜¯æ‘˜è¦ä¿¡æ¯ï¼Œ**æ‰€ä»¥JWTä»…ä»…ä¿è¯çš„æ˜¯å…¶ä¸­åŒ…å«çš„ä¿¡æ¯ä¸ä¼šè¢«ç¯¡æ”¹ï¼Œå¹¶çŸ¥é“æ˜¯å¦æ˜¯å·±æ–¹æœåŠ¡åˆ†å‘çš„ä»¤ç‰Œï¼Œå¹¶ä¸ä¿è¯ä¿¡æ¯çš„æ³„éœ²**ã€‚

### è¯´è¯´ç¼ºç‚¹

JWTçš„ç‰¹ç‚¹æ—¢æ˜¯å®ƒçš„ä¼˜ç‚¹ï¼Œä¹Ÿæ˜¯å®ƒçš„ç¼ºç‚¹

- **ä»¤ç‰Œåˆ†å‘ä¹‹åï¼Œä¸å—æœåŠ¡å™¨æ§åˆ¶**ï¼š
	- ä¹‹å‰Cookie-Sessionæ–¹å¼ç”±äºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ç»Ÿä¸€ç®¡ç†åœ¨äº†æœåŠ¡ç«¯ï¼Œè™½ç„¶æœ‰ä¸€å®šçš„ç®¡ç†æˆæœ¬ï¼Œç‰¹åˆ«æ˜¯åœ¨åˆ†å¸ƒå¼æœåŠ¡ä¸­æˆæœ¬æ›´å¤§ï¼Œä½†ç›¸å¯¹æ¥è¯´æ›´å®¹æ˜“æ§åˆ¶ã€‚
	- è€ŒJWTæ˜¯ç›´æ¥å°†ç”¨æˆ·ä¿¡æ¯ç»è¿‡å¤„ç†ï¼š
		- é€šè¿‡æ‘˜è¦ä¿è¯æ•°æ®ä¸å¯è¢«ä¿®æ”¹ï¼Œä¸€æ—¦ä¿®æ”¹ï¼Œåç»­éªŒè¯å°±ä¼šå¤±æ•ˆï¼›
		- é€šè¿‡(é)å¯¹ç§°åŠ å¯†ä¿è¯è¿™æ˜¯å·±æ–¹æœåŠ¡å™¨åˆ†å‘çš„ä»¤ç‰Œï¼Œæ˜¯ä¸å¯æŠµèµ–çš„
		- è€Œç›¸å…³ç”¨æˆ·ä¿¡æ¯æ˜¯å­˜å‚¨åœ¨å››é¢å…«æ–¹çš„å®¢æˆ·æœºä¸Šçš„
		- æ‰€ä»¥æˆ‘ä»¬æœåŠ¡å™¨å¾ˆéš¾æ§åˆ¶ç›¸å…³ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œæ¯”å¦‚è®©æŸä¸ªç”¨æˆ·å¼ºåˆ¶ä¸‹çº¿ï¼Œåœ¨çº¿ç”¨æˆ·å®æ—¶ç»Ÿè®¡ç­‰ç­‰
- **å¦‚æœä¸ä½¿ç”¨HTTPSï¼Œæ›´åŠ å®¹æ˜“é­åˆ°é‡æ”¾æ”»å‡»**ï¼šHTTPSå¯ä»¥ä¿è¯ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ä»¤ç‰Œä¸ä¼šè¢«æ³„éœ²ï¼Œä½†å¦‚æœæ²¡æœ‰ä½¿ç”¨HTTPSæˆ–è€…ä»¥å…¶ä»–æ–¹å¼æ³„éœ²ä»¤ç‰Œï¼Œæ‹¿åˆ°ä»¤ç‰Œçš„æ”»å‡»æ–¹å¹¶ä¸éœ€è¦ä¿®æ”¹ä»¤ç‰Œï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“åœ°å†’å……ç”¨æˆ·æ¬ºéª—æœåŠ¡å™¨ã€‚Cookie-Session ä¹Ÿæ˜¯æœ‰é‡æ”¾æ”»å‡»é—®é¢˜çš„ï¼Œåªæ˜¯å› ä¸º Session ä¸­çš„æ•°æ®æ§åˆ¶åœ¨æœåŠ¡ç«¯æ‰‹ä¸Šï¼Œåº”å¯¹é‡æ”¾æ”»å‡»ä¼šç›¸å¯¹ä¸»åŠ¨ä¸€äº›ã€‚

---

å…¶ä»–çš„ä¸€äº›ç¼ºç‚¹ï¼Œè¿™äº›ä¸JWTæœ¬èº«çš„ç‰¹æ€§æ— å…³ï¼Œä»…å­˜åœ¨äºè¯¥åœºæ™¯ä¸­ï¼Œå°±è¦éµå®ˆè¯¥åœºæ™¯çš„è§„åˆ™ï¼Œæˆ–è€…è¯´å¦‚æœè¯¥åœºæ™¯æœ¬æ¥å°±æœ‰äº›é—®é¢˜ï¼Œé‚£ä¹ˆJWTä¹Ÿä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

- **æºå¸¦çš„æ•°æ®æœ‰é™**ï¼šJWTåœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ä¸€èˆ¬æ˜¯å­˜æ”¾åœ¨`Authorization Header`ä¸­çš„ï¼Œè€Œå…¶æ•°æ®çš„é•¿åº¦å—é™äºå„ç§æœåŠ¡å™¨ã€æµè§ˆå™¨çš„é™åˆ¶ï¼›å°±å¥½æ¯”GETè¯·æ±‚çš„é•¿åº¦é™åˆ¶é¦–å…ˆäºæµè§ˆå™¨å¯¹URLçš„é•¿åº¦é™åˆ¶ä¸€æ ·
- **ä»¤ç‰Œå­˜å‚¨**ï¼šå­˜å‚¨åœ¨å®¢æˆ·ç«¯æ„å‘³ç€æœ‰å¤šç§é€‰æ‹©ï¼šCookieï¼ŸLocal Storageï¼Ÿå¦‚æœæ”¾åœ¨ Cookie ä¸­ï¼Œä¸ºäº†å®‰å…¨ï¼Œä¸€èˆ¬ä¼šç»™ Cookie è®¾ç½® `http-only` å’Œ `secure` çš„å±æ€§ã€‚ä½†è¿™ä¹Ÿä¼šå¸¦æ¥ä¸€å®šçš„ä¸ä¾¿æ€§ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯è¦è¯»å– JWT Payload çš„å†…å®¹åªèƒ½å€ŸåŠ©æœåŠ¡ç«¯ API æ¥å£ã€‚å¦‚æœå°† JWT å­˜å‚¨è‡³æµè§ˆå™¨ Local Storageï¼Œè™½ç„¶æ–¹ä¾¿äº†å®¢æˆ·ç«¯è¯»å–ï¼Œä½†å¯èƒ½ä¼šå¸¦æ¥ XSS æ”»å‡»çš„å¨èƒï¼Œåˆéœ€è¦å»è®¾ç½® CSP æ¥é˜²å¾¡è¿™ç§å¨èƒï¼›

### åŒtokenä½œç”¨

ç®€å•æ¥è¯´ä¹Ÿæ˜¯ä¸ºäº†å‡è½»JWTè¢«æ³„éœ²è€Œé€ æˆçš„å½±å“ï¼Œå…·ä½“æ¥è¯´åˆ†ä¸º`refresh token`å’Œ`access token`

| |access token|refresh token|
|-|-|-|
|æœ‰æ•ˆæ—¶é•¿|è¾ƒçŸ­(å¦‚åŠå°æ—¶)|è¾ƒé•¿(å¦‚ä¸€å¤©)|
|ä½œç”¨|éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æ“ä½œæƒé™|è·å–access token|
|ä»€ä¹ˆæ—¶å€™ä½¿ç”¨|æ¯æ¬¡éœ€è¦ç”¨æˆ·ç™»å½•æ€æ—¶ä¼ é€’è¯¥token|access tokenå¤±æ•ˆæ—¶ä½¿ç”¨|

è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼š

1. `access token`é¢‘ç¹ä¼ è¾“ï¼Œæ³„éœ²é£é™©è¾ƒå¤§ï¼Œæ‰€ä»¥å°†å…¶æœ‰æ•ˆæœŸè®¾ä¸ºè¾ƒçŸ­å¯ä»¥æœ‰æ•ˆé™ä½æ³„éœ²è€Œé€ æˆçš„å½±å“ï¼Œæ¯”å¦‚æ­¤æ—¶æ”»å‡»æ–¹æœ€å¤šä¼ªè£…ä½ åŠä¸ªå°æ—¶;
2. `access token`å­˜åœ¨æ—¶é—´è¾ƒçŸ­ï¼Œéœ€è¦é¢‘ç¹è·å–æ–°çš„ï¼Œä¸ºäº†é™ä½ç”¨æˆ·ç™»å½•æ¬¡æ•°ï¼Œæé«˜ç”¨æˆ·ä½“éªŒï¼Œä½¿ç”¨`refresh token`è°ƒç”¨ç›¸å…³æ¥å£è·å–æœ€æ–°çš„`access token`ã€‚
3. `refresh token`å­˜åœ¨æ—¶é—´é•¿ï¼Œæ³„éœ²åå½±å“è¾ƒå¤§ï¼Œæ‰€ä»¥åªæœ‰åœ¨`access token`å¤±æ•ˆæ—¶æ‰ä¼ é€’ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šé¢‘ç¹ä¼ è¾“ï¼Œå³æ³„éœ²é£é™©è¾ƒå°

ä¸»è¦å°±æ˜¯å…¼é¡¾æ³„éœ²tokençš„é£é™©ä¸æ³„éœ²tokençš„å½±å“

## æœ€å

æŠ€æœ¯æ›´åº”è¯¥æ˜¯å®¢è§‚ç†æ€§çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æœ€å¼€å§‹å†™é‚£ä¸ªæœç´¢å¼•æ“çš„è¯¯åŒºï¼Œè®¤ä¸ºJWTæ˜¯åç»­å‡ºç°çš„ï¼Œæ›´åŠ å…ˆè¿›ï¼Œæ‰€ä»¥ç™»å½•æŠ€æœ¯æ ˆå°±é€‰ç”¨äº†å®ƒï¼Œä½†ä¼¼ä¹æƒ³æƒ³ï¼Œè¿™ä¸ªå°ç³»ç»Ÿæ—¢æ²¡æœ‰åˆ†å¸ƒå¼ï¼Œä¹Ÿä¸æ˜¯APPï¼Œä¹Ÿè®¸é€‰ç”¨Cookie-Sessionæ–¹å¼æ›´åŠ åˆé€‚ï¼Œå½“ç„¶æ²¡æœ‰ç»å¯¹~

> JWT ä»¤ç‰Œä¸ Cookie-Session å¹¶ä¸æ˜¯å®Œå…¨å¯¹ç­‰çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒåªç”¨æ¥å¤„ç†è®¤è¯æˆæƒé—®é¢˜ï¼Œå……å…¶é‡èƒ½æºå¸¦å°‘é‡éæ•æ„Ÿçš„ä¿¡æ¯ï¼Œåªæ˜¯ Cookie-Session åœ¨è®¤è¯æˆæƒé—®é¢˜ä¸Šçš„æ›¿ä»£å“ï¼Œè€Œä¸èƒ½è¯´ JWT è¦æ¯” Cookie-Session æ›´åŠ å…ˆè¿›ï¼Œæ›´ä¸å¯èƒ½å…¨é¢å–ä»£ Cookie-Session æœºåˆ¶ã€‚

å¦‚æœ‰é”™è¯¯ï¼Œå¸Œæœ›å„ä½ä¸åèµæ•™ï¼Œå‹å–„æŒ‡å‡º...

## å‚è€ƒ

- [å‡¤å‡°æ¶æ„-æ¶æ„å®‰å…¨æ€§](https://icyfenix.cn/architect-perspective/general-architecture/system-security/)
- [å¤§å‹ç½‘ç«™çš„ç”¨æˆ·ç™»å½•ç³»ç»Ÿæ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ](https://www.zhihu.com/question/25400195)
- [JSON Web Token å…¥é—¨æ•™ç¨‹](https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html)
- [JSON Web Token ç®€ä»‹](https://jwt.io/introduction)
- [What is a JWT? Understanding JSON Web Tokens](https://supertokens.com/blog/what-is-jwt)
- [è¯´ä¸€è¯´å‡ ç§å¸¸ç”¨çš„ç™»å½•è®¤è¯æ–¹å¼ï¼Œä½ ç”¨çš„å“ªç§](https://cloud.tencent.com/developer/article/1080808)
- [ä½¿ç”¨Sessionå’ŒCookie](https://www.liaoxuefeng.com/wiki/1252599548343744/1328768897515553)

