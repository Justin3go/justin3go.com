# ä¸€æ–‡æ¢³ç†Vue3æ ¸å¿ƒåŸç†

## å‰è¨€

==**âš ä¸‡å­—é•¿æ–‡warn**==æœ¬ç¯‡æ–‡ç« æ›´å¤šæ˜¯ä»¥æ¢³ç†çš„è§†è§’è¿›è¡Œè®²è¿°ï¼Œå°†å„ä¸ªåŸç†ç»†èŠ‚ä¸²åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿æŸ¥æ¼è¡¥ç¼ºï¼Œè€Œéä¸ºäº†è®²æ‡‚æŸä¸ªåŸç†ï¼Œå½“ç„¶ä¹Ÿä¼šå¤§è‡´è®²è§£ã€‚æ‰€ä»¥å¦‚æœæŸä¸ªåŸç†ä¸å¤ªæ¸…æ¥šï¼Œè¯·è‡ªè¡ŒæŸ¥é˜…å…¶ä»–æ–‡ç« ï¼Œæˆ‘ä¹Ÿä¼šå°½é‡ç»™å‡ºç›¸å…³çš„é˜…è¯»æ¨èã€‚

==æœ¬æ–‡é˜…è¯»éœ€è¦ä½ æœ‰ä¸€å®šçš„vueåº”ç”¨ç¨‹åºå¼€å‘ç»éªŒå¹¶äº†è§£ä¸€äº›åŸç†==

>  æ¥ä¸‹æ¥å…ˆåºŸè¯ä¸€ä¸‹ï¼Œå…³æ³¨çŸ¥è¯†ç‚¹çš„å¯ä»¥ç›´æ¥è·³è¿‡å‰è¨€éƒ¨åˆ†

é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå›åˆ°æœ€åˆçš„èµ·ç‚¹æ˜¯**ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Vueæ¡†æ¶**ï¼Œå®ƒä¸ºæˆ‘ä»¬åšäº†ä»€ä¹ˆå·¥ä½œï¼š

1. èƒ½å¼€å‘å‡ºä¸€ä¸ªåº”ç”¨ï¼Ÿ
2. æ€§èƒ½å¥½ã€æ„å»ºäº§ç‰©è½»é‡ï¼Ÿ
3. å¯¹ç”¨æˆ·å‹å¥½ï¼Œå£°æ˜å¼ä»£ç å¿ƒæ™ºè´Ÿæ‹…å°ï¼Ÿ
4. å¯ç»„ä»¶åŒ–å¼€å‘ï¼Ÿ
5. ç¤¾åŒºæ´»è·ƒï¼Œç”Ÿæ€ä¸°å¯Œï¼Ÿ
6. ...

æ— è®ºæ˜¯å®˜ç½‘ä»‹ç»çš„ä¼˜ç‚¹ï¼Œè¿˜æ˜¯ç½‘å‹ä»¬æå‡ºçš„ä¼˜ç‚¹...é¦–å…ˆè¿™äº›éƒ½æ˜¯æ¯‹åº¸ç½®ç–‘çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªæˆç†Ÿæ¡†æ¶å¿…å¤‡çš„ä¸€äº›å±æ€§ã€‚

å¥½ï¼Œæˆ‘ä»¬æ¥è¯´ä½†æ˜¯ï¼šå¯¹äºä¸€ä¸ªæ¡†æ¶ä½¿ç”¨è€…ï¼Œæˆ‘ä»¬å½“ç„¶å¸Œæœ›åŠŸèƒ½è¶Šä¸°å¯Œè¶Šå¥½ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªæ¡†æ¶åˆæœŸå­¦ä¹ è€…ï¼Œæˆ‘ä»¬åˆ™éœ€è¦çš„æ˜¯å…³æ³¨æ ¸å¿ƒé“¾è·¯

> å°±æ¯”å¦‚[`<KeepAlive>`ç»„ä»¶](https://cn.vuejs.org/guide/built-ins/keep-alive.html)åŸç†æˆ‘ä»¬å‰æœŸæœ‰å¿…è¦å­¦ä¹ å—ï¼Ÿé™¤éä½ ç›®å‰é‡åˆ°è¿‡è¿™æ ·çš„é—®é¢˜ï¼Œå¦åˆ™ä¸å»ºè®®æœ‰é™çš„æ—¶é—´å…ˆå­¦å®ƒã€‚å’Œç©æ¸¸æˆçš„é“ç†ä¸€æ ·ï¼Œå…ˆåšä¸»çº¿ä»»åŠ¡ï¼Œå†æ ¹æ®æ—¶é—´å®‰æ’æ¥å–ä¸€äº›ä¸–ç•Œä»»åŠ¡...

è¿™ä¹Ÿæ˜¯ç¬”è€…å†™æœ¬æ–‡çš„åŸå› ï¼Œåœ¨è¿™é‡Œæˆ‘ç†è§£æœ€ä¸»è¦çš„å°±æ˜¯è¦æ‰®æ¼”å¥½[MVVM](https://juejin.cn/post/6844903929298288647#heading-0)ä¸­çš„ViewModelè§’è‰²ï¼š

ViewModelå±‚é€šè¿‡**åŒå‘æ•°æ®ç»‘å®š**å°†Viewå±‚å’ŒModelå±‚è¿æ¥äº†èµ·æ¥ï¼Œä½¿å¾—Viewå±‚å’ŒModelå±‚çš„åŒæ­¥å·¥ä½œå®Œå…¨æ˜¯è‡ªåŠ¨çš„

è¿™ä¹Ÿå¯èƒ½ä¸ºä»€ä¹ˆè¿™æ˜¯å®˜ç½‘ä»‹ç»çš„[ç¬¬ä¸€ä¸ªä¾‹å­](https://cn.vuejs.org/guide/introduction.html#what-is-vue)ï¼š

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230128230710.png)

æ¥ä¸‹æ¥å°±è¿›å…¥æ­£é¢˜ï¼Œçœ‹çœ‹æ¡†æ¶åœ¨èƒŒååšäº†å“ªäº›å·¥ä½œğŸ‘Šï¼Œå¹¶ä¸”ç¬”è€…ä¼šåœ¨æ–‡æœ«ç»™å‡ºå‡ ä¸ªæ‰©å±•é—®é¢˜ä¾›å¤§å®¶æ€è€ƒ...

## æ¦‚æ‹¬

æŠŠæ¡†æ¶ç†è§£ä¸ºä¸€ä¸ªå°è£…å¥½çš„å‡½æ•°ï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦ç¡®è®¤å‡½æ•°çš„è¾“å…¥ä»¥åŠå‡½æ•°çš„è¿”å›ã€‚åœ¨è¿™é‡Œï¼Œç”¨æˆ·ï¼ˆå¼€å‘è€…ï¼‰çš„è¾“å…¥å°±æ˜¯å•æ–‡ä»¶ç»„ä»¶ï¼Œè¾“å‡ºå°±æ˜¯å¸¦æœ‰ä¸€äº›ä¼˜ç§€ç‰¹æ€§çš„å¯è¿è¡Œçš„ä»£ç ã€ç”¨æˆ·é¢„æœŸçš„ç»“æœï¼Œæ¯”å¦‚ä¸Šè¿°è¿™ä¸ª`count`ä¾‹å­çš„ç»“æœå±•ç¤ºã€‚

> æºç åˆ†æ”¯è¾ƒå¤šï¼Œç»†èŠ‚ä¸°å¯Œã€‚å¦‚ä¸‹å›¾å¾ˆéš¾å¤§è€Œå…¨åœ°æ¦‚æ‹¬æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ï¼Œä»…ä¾›å‚è€ƒï¼Œä¹Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºå‹å–„æå‡ºä½ çš„æƒ³æ³•ã€‚

![](https://oss.justin3go.com/blogs/Vue%E5%8E%9F%E7%90%86%E6%A2%B3%E7%90%86.png)

é¦–å…ˆæˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‰ç…§Vueæ ¼å¼å†™çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šç»è¿‡å¦‚ä¸‹æ­¥éª¤æˆä¸ºæœ€ç»ˆåœ¨æµè§ˆå™¨ä¸Šè¿è¡Œæ˜¾ç¤ºçš„æ–‡ä»¶ï¼š

0. å°†æºæ–‡ä»¶é€šè¿‡ç¼–è¯‘æ‰‹æ®µè½¬æ¢ä¸ºä¸€ä¸ªç»„ä»¶å¯¹è±¡ï¼Œå…¶ä¸­renderå‡½æ•°çš„è¿”å›å€¼æ˜¯è¯¥ç»„ä»¶å¯¹åº”çš„è™šæ‹ŸDOM
1. å°†ç»„ä»¶å¯¹è±¡äº¤ç»™æ¸²æŸ“æ¨¡å—è¿›è¡Œåˆå§‹åŒ–
2. ä½¿ç”¨`ReactiveEffect()`å‡½æ•°å¯¹è¯¥ç»„ä»¶å¯¹è±¡çš„æ¸²æŸ“ä»»åŠ¡è¿›è¡ŒåŒ…è£…ï¼Œå³ä¾èµ–æ”¶é›†ã€‚
3. é€šè¿‡VNodeæ¸²æŸ“å‡ºå¯¹åº”çš„HTMLæŒ‚è½½åˆ°é¡µé¢ä¸Š
4. ç”¨æˆ·æ“ä½œé¡µé¢ä¸­çš„å“åº”å¼æ•°æ®åï¼Œè§¦å‘æ›´æ–°
5. å“åº”å¼æ¨¡å—æ ¹æ®å“åº”å¼æ•°æ®æ‰¾åˆ°å…¶ä¾èµ–çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œä»¥æ›´æ–°é¡µé¢ã€å“åº”ç”¨æˆ·ã€‚

## ç¼–è¯‘å™¨

ç¼–è¯‘åŸç†æ˜¯ä¸€é—¨å¤æ‚çš„å­¦ç§‘ï¼Œå½“æ—¶åšè¿™é—¨è¯¾çš„è¯¾è®¾æ—¶ä¹Ÿæ˜¯å¿ƒæ€ç‚¸è£‚ï¼Œéš¾å¿˜çš„ç»å†ã€‚è¿™é‡Œä¸€ä¸¤å¥ï¼Œç”šè‡³ä¸€ä¸¤ç¯‡æ–‡ç« éƒ½å¾ˆéš¾è®²æ˜ç™½ã€‚ä½†ä¸æ˜¯å¾ˆå½±å“æ¥ä¸‹æ¥çš„å†…å®¹ï¼Œå¦‚æœä½ å¯¹ç¼–è¯‘åŸç†æœ‰ä¸€å®šçš„äº†è§£å½“ç„¶æœ€å¥½ï¼Œæ²¡æœ‰çš„è¯ä½ åªéœ€è¦ç†è§£å¦‚ä¸‹éå¸¸ç®€å•çš„å†…å®¹ï¼š

- å‡è®¾æºå†…å®¹ä¸º`I am Justin3go`
- ç»è¿‡ç¼–è¯‘å™¨å†…éƒ¨ç»“æ„è¯†åˆ«æˆ‘ä»¬è¯†åˆ«åˆ°äº†`(I => ä¸»è¯­) (am => è°“è¯­) (Justin3go => å®¾è¯­)`
- å‡è®¾æˆ‘è®¾è®¡çš„ç¼–è¯‘å™¨åŠŸèƒ½å°±æ˜¯ä¸»è°“äº’æ¢ï¼Œæ‰€ä»¥ç»“æœå°±æ˜¯`Justin3go am I`ï¼ˆè¿™é‡Œå¿½ç•¥è‹±è¯­è¯­æ³•çš„é—®é¢˜ï¼‰
- å†ç®€å•æ¥è¯´å°±æ˜¯åšå­—ç¬¦ä¸²å¤„ç†ï¼Œæ ¹æ®åŸæœ‰ç»“æ„è¿›è¡Œæ–‡æœ¬æ›¿æ¢å¢åˆ ä»¥å®ç°ç›®æ ‡åŠŸèƒ½

*PSï¼šç¼–è¯‘åŸç†å¯¹äºå‰ç«¯æ¥è¯´ä¹Ÿæ˜¯ä¸€é—¨éå¸¸é‡è¦çš„è¯¾ç¨‹ï¼Œæœ‰æ—¶é—´å°±çœ‹çœ‹ä¹¦ç ”ç©¶ä¸€ä¸‹å§ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘åç»­çš„å­¦ä¹ è®¡åˆ’ã€‚*

è€Œå›åˆ°è¿™é‡Œæ— éå°±æ˜¯è¯†åˆ«HTMLä¸­çš„ç‰¹æ®Šè¯­æ³•ã€å­—ç¬¦ï¼ˆå¦‚ï¼š`v-model`ã€åŒèŠ±æ‹¬å·ç­‰ï¼‰è¿›è¡Œè½¬æ¢æˆ–è€…æ‰“ä¸Šæ ‡è®°ç­‰ç­‰

==è¿˜æ˜¯é‚£å¥è¯ï¼Œç¼–è¯‘åŸç†éƒ¨åˆ†è¿™é‡Œä¸è¿›è¡Œå™è¿°ï¼Œæ¥ä¸‹æ¥ä¸»è¦å¯¹é’ˆå¯¹Vueæ¡†æ¶ç‰¹æœ‰çš„ç¼–è¯‘ä¼˜åŒ–è¿›è¡Œäº†è§£ï¼Œä¸€äº›æ€æƒ³è¿˜æ˜¯éå¸¸å€¼å¾—å­¦ä¹ çš„==

**æ¨èé“¾æ¥**ï¼š

- ä½ å¯ä»¥åœ¨å®˜ç½‘çš„è¿™ä¸ªä½ç½®ï¼š[å‚è€ƒé“¾æ¥](https://cn.vuejs.org/guide/extras/rendering-mechanism.html#compiler-informed-virtual-dom)æ‰¾åˆ°å¯¹åº”çš„è®²è§£
- ä½ å¯ä»¥åœ¨[æ¨¡æ¿ç¼–è¯‘é¢„è§ˆå™¨](https://template-explorer.vuejs.org/)ä¸­è‡ªè¡Œå¿«é€Ÿå®è·µï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼šä½ å¯ä»¥åœ¨å³ä¸Šè§’Optionsèœå•ä¸­å¼€å¯ç›¸å…³çš„ä¼˜åŒ–é€‰é¡¹ä»¥éªŒè¯æƒ³æ³•

### Blockæ ‘ä¸åŠ¨æ€ç»“ç‚¹æ”¶é›†

**1ï¼‰ä¸ºä»€ä¹ˆä¼šæœ‰Blockæ ‘çš„å‡ºç°**ï¼š

æˆ‘ä»¬çŸ¥é“HTMLæ¨¡æ¿åœ¨renderå‡½æ•°ä¸­æ˜¯ä»¥æ ‘çŠ¶ç»“æ„è¡¨ç¤ºçš„ã€‚éšç€é¡¹ç›®çš„å¤æ‚åº¦å¢åŠ ï¼Œè¿™ä¸ªæ ‘çš„å¤æ‚åº¦ä¹Ÿéšä¹‹å¢åŠ ï¼Œéå†å¹¶æ¯”è¾ƒæ–°æ—§çš„éš¾åº¦ä¹Ÿå¢åŠ ã€‚å¦‚æœæˆ‘ä»¬æŠŠå…¶ä¸­æŸäº›å­æ ‘åˆ†åˆ«çœ‹ä½œæ•´ä½“ï¼Œå³ä½œä¸ºç»“ç‚¹ï¼Œé‚£ä¹ˆè¿™é¢—æ ‘çš„å¤æ‚åº¦ä¼šå¤§å¤§é™ä½ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://oss.justin3go.com/blogs/Block%E6%A0%91.png)

**2ï¼‰ä¸ºä»€ä¹ˆå¯ä»¥æŠŠæŸäº›å­æ ‘çœ‹ä½œæ•´ä½“Block**ï¼š

å› ä¸ºè¿™äº›Blockä¸éœ€è¦å†è¿›è¡Œéå†ï¼Œå› ä¸ºç¼–è¯‘å™¨åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šå°†å…¶ä¸­çš„åŠ¨æ€ç»“ç‚¹ï¼ˆä¼šè¢«æ›´æ–°çš„ç»“ç‚¹ï¼‰è¿›è¡Œäº†ä»¥Blockä¸ºå•ä½è¿›è¡Œäº†æ”¶é›†ï¼Œå°†è¿™äº›åŠ¨æ€ç»“ç‚¹ä»¥æ•°ç»„çš„å½¢å¼å­˜å‚¨åœ¨äº†Blockä¸Šï¼Œå°±æ˜¯ç®—æ³•ä¸­ç»å…¸çš„ç©ºé—´æ¢æ—¶é—´æ€æƒ³ã€‚æ•…åç»­ä¸éœ€è¦éå†Blockçš„å†…éƒ¨ç»“æ„äº†ï¼Œå› ä¸ºæœ‰ä¸ªæ‰å¹³çš„æ•°ç»„ç»“æ„å­˜å‚¨äº†æ›´æ–°éœ€è¦çš„å¿…è¦ä¿¡æ¯ã€‚

**3ï¼‰Blockæ˜¯å¦‚ä½•è¿›è¡Œåˆ’åˆ†çš„**ï¼š

- æ¨¡æ¿çš„æ ¹ä½œä¸ºä¸€ä¸ªBlockï¼Œæ¯ä¸ªBlockä¼šæ”¶é›†å†…éƒ¨é™¤äº†å­BlockåŒ…å«çš„ç»“ç‚¹ä¹‹å¤–çš„æ‰€æœ‰åŠ¨æ€ç»“ç‚¹
- `v-if`ã€`v-for`ç­‰å¯èƒ½æ”¹å˜ç»“ç‚¹ç»“æ„çš„æŒ‡ä»¤å¯¹åº”çš„æ ‡ç­¾ä½œä¸ºä¸€ä¸ªblock

å€¼å¾—ä¸€è¯´çš„æ˜¯ï¼Œå‡è®¾ä¸å°†è¿™äº›ç»“æ„æŒ‡ä»¤ä½œä¸ºä¸€ä¸ªblockçš„è¯ï¼š

- `v-if`æœ‰å¯èƒ½è®©ç»“ç‚¹ç»“æ„ä»æ•´ä¸ªæ ‘ä¸Šæ¶ˆå¤±ï¼Œæ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶å°±ä¸èƒ½ä½œå‡ºå®‰å…¨çš„å‡è®¾ï¼Œæ¯”å¦‚æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œ`v-if`å†…éƒ¨çš„åŠ¨æ€ç»“ç‚¹åº”è¯¥è¢«æ”¶é›†åˆ°ä¸Šå±‚Blockçš„æ•°ç»„ä¸­ï¼›ä½†æ¡ä»¶ä¸ºå‡æ—¶ï¼Œå°±ä¸åº”è¯¥è¢«æ”¶é›†ï¼Œæ‰€ä»¥æ¡†æ¶å°†å…¶ä½œä¸ºä¸€ä¸ªBlockå°±å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼šå°†è¯¥ç»“æ„æŒ‡ä»¤å†…çš„åŠ¨æ€ç»“ç‚¹æ”¶é›†åˆ°è¯¥Blockä¸­ï¼Œè¿™ä¸ªåŠ¨æ€ç»“ç‚¹çš„ä¿¡æ¯å°±èƒ½éšç€ç»“æ„çš„åˆ‡æ¢è€Œå‡ºç°æˆ–æ¶ˆå¤±äº†
- `v-for`æŒ‡ä»¤åŒæ ·å¦‚æ­¤ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½æ— æ³•é¢„å…ˆçŸ¥é“å…¶ä¼šæ¸²æŸ“å¤šå°‘ä¸ªç»“ç‚¹

### é™æ€ç»“ç‚¹ä¼˜åŒ–

é™æ€ç»“ç‚¹ï¼šåœ¨åç»­æ›´æ–°æ—¶æ°¸è¿œä¸ä¼šæ”¹å˜çš„ç»“ç‚¹ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–‡æœ¬ç»“ç‚¹

è€Œé™æ€ä¼˜åŒ–ï¼ˆ[é™æ€æå‡](https://vue-next-template-explorer.netlify.app/#eyJzcmMiOiI8ZGl2PlxuICA8ZGl2PmZvbzwvZGl2PlxuICA8ZGl2PmJhcjwvZGl2PlxuICA8ZGl2Pnt7IGR5bmFtaWMgfX08L2Rpdj5cbjwvZGl2PiIsInNzciI6ZmFsc2UsIm9wdGlvbnMiOnsiaG9pc3RTdGF0aWMiOnRydWV9fQ==)ï¼‰å°±æ˜¯å°†è¿™äº›é™æ€ç»“ç‚¹ä¿å­˜åˆ°æ¸²æŸ“å‡½æ•°ä¹‹å¤–ï¼Œæ¸²æŸ“å‡½æ•°ä»…å¼•ç”¨è¿™äº›é™æ€ç»“ç‚¹ï¼Œè¿™æ ·åšçš„**ä¼˜ç‚¹**å°±æ˜¯ï¼š

-   é¿å…é‡æ–°åˆ›å»ºå¯¹è±¡ï¼Œç„¶åæ‰”æ‰é€ æˆçš„æ€§èƒ½æŸå¤±ï¼Œæ¯•ç«Ÿæ˜¯é™æ€ç»“ç‚¹ä¸ä¼šå˜åŒ–
-   åœ¨æ›´æ–°é¡µé¢æ—¶ï¼Œæ¸²æŸ“å™¨å¯ä»¥ç›´æ¥è·³è¿‡æ–°æ—§VNodeè¿™éƒ¨åˆ†çš„æ¯”è¾ƒ

> æ­¤å¤–ï¼Œå½“æœ‰è¶³å¤Ÿå¤šè¿ç»­çš„é™æ€å…ƒç´ æ—¶ï¼Œå®ƒä»¬è¿˜ä¼šå†è¢«å‹ç¼©ä¸ºä¸€ä¸ªâ€œé™æ€ vnodeâ€ï¼Œå…¶ä¸­åŒ…å«çš„æ˜¯è¿™äº›èŠ‚ç‚¹ç›¸åº”çš„çº¯ HTML å­—ç¬¦ä¸²ã€‚([ç¤ºä¾‹](https://vue-next-template-explorer.netlify.app/#eyJzcmMiOiI8ZGl2PlxuICA8ZGl2IGNsYXNzPVwiZm9vXCI+Zm9vPC9kaXY+XG4gIDxkaXYgY2xhc3M9XCJmb29cIj5mb288L2Rpdj5cbiAgPGRpdiBjbGFzcz1cImZvb1wiPmZvbzwvZGl2PlxuICA8ZGl2IGNsYXNzPVwiZm9vXCI+Zm9vPC9kaXY+XG4gIDxkaXYgY2xhc3M9XCJmb29cIj5mb288L2Rpdj5cbiAgPGRpdj57eyBkeW5hbWljIH19PC9kaXY+XG48L2Rpdj4iLCJzc3IiOmZhbHNlLCJvcHRpb25zIjp7ImhvaXN0U3RhdGljIjp0cnVlfX0=))ã€‚è¿™äº›é™æ€èŠ‚ç‚¹ä¼šç›´æ¥é€šè¿‡Â `innerHTML`Â æ¥æŒ‚è½½ã€‚åŒæ—¶è¿˜ä¼šåœ¨åˆæ¬¡æŒ‚è½½åç¼“å­˜ç›¸åº”çš„ DOM èŠ‚ç‚¹ã€‚å¦‚æœè¿™éƒ¨åˆ†å†…å®¹åœ¨åº”ç”¨ä¸­å…¶ä»–åœ°æ–¹è¢«é‡ç”¨ï¼Œé‚£ä¹ˆå°†ä¼šä½¿ç”¨åŸç”Ÿçš„Â `cloneNode()`Â æ–¹æ³•æ¥å…‹éš†æ–°çš„ DOM èŠ‚ç‚¹ï¼Œè¿™ä¼šéå¸¸é«˜æ•ˆã€‚

### å†…è”äº‹ä»¶ä¼˜åŒ–

å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹æ¨¡æ¿ä»£ç ï¼š

```html
<div>
  <div id="foo" @click="onClick">hello</div>
</div>
```

åœ¨ä¸è¿›è¡Œäº‹ä»¶ç¼“å­˜ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œä¼šè¢«ç¼–è¯‘æˆå¦‚ä¸‹æ¸²æŸ“å‡½æ•°ï¼š

```js{7-8}
import { createElementVNode as _createElementVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from "vue"

export function render(_ctx, _cache, $props, $setup, $data, $options) {
  return (_openBlock(), _createElementBlock("div", null, [
    _createElementVNode("div", {
      id: "foo",
      onClick: _ctx.onClick
    }, "hello", 8 /* PROPS */, ["onClick"])
  ]))
}
```

ä¸Šè¿°`render`å‡½æ•°åœ¨è¿›è¡Œæ›´æ–°æ—¶ï¼Œ`{ id: "foo",onClick: _ctx.onClick}`å¿…é¡»ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œdiffï¼Œä¸ç®¡æœ‰å¤šå°‘ä¸œè¥¿åœ¨è¿™`div`ä¸Šï¼Œæ¯”å¦‚æœ‰éå¸¸å¤šçš„å­ç»“ç‚¹ç­‰ç­‰ã€‚

æ‰€ä»¥å³ä½¿ä»æ¨¡æ¿ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªIDå®é™…ä¸Šæ˜¯é™æ€çš„ï¼Œæ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šéå†æ•´ä¸ªå¯¹è±¡ï¼Œåªæ˜¯ä¸ºäº†ç¡®ä¿å®ƒä¸ä¼šæ”¹å˜ï¼Œå› ä¸ºè¿è¡Œæ—¶æ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥çŸ¥é“è¿™æ–¹é¢ã€‚

è€Œå¼€å¯äº‹ä»¶ç¼“å­˜ä¼˜åŒ–ä¹‹åï¼Œå¦‚ä¸‹ï¼š

```js{7}
import { createElementVNode as _createElementVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from "vue"

export function render(_ctx, _cache, $props, $setup, $data, $options) {
  return (_openBlock(), _createElementBlock("div", null, [
    _createElementVNode("div", {
      id: "foo",
      onClick: _cache[0] || (_cache[0] = (...args) => (_ctx.onClick && _ctx.onClick(...args)))
    }, "hello")
  ]))
}
```

éå¸¸ç®€å•çš„ä»£ç ï¼Œå°±æ˜¯å¦‚æœæœ‰ç¼“å­˜ï¼Œè¯»å–ç¼“å­˜ä¸Šçš„äº‹ä»¶ï¼Œå¦‚æœå¯¹åº”ä½ç½®æ²¡æœ‰ç¼“å­˜ï¼Œåˆ™é‡æ–°ä»ä¸Šä¸‹æ–‡ä¸­è·å–è¯¥äº‹ä»¶ã€‚

è¿™æ ·åšçš„**ä¼˜ç‚¹**æ˜¯ï¼šæ­¤æ—¶è¯¥ç»„ä»¶å¯¹è±¡ä¸­çš„æ‰€æœ‰äº‹ä»¶éƒ½æ˜¯â€œä¸å˜çš„â€ï¼Œéƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå˜åŒ–çš„æ˜¯æŒ‡å‘çš„å¯¹è±¡ï¼Œè¿™æ ·æ— è®ºäº‹ä»¶å¯¹åº”çš„å€¼å¦‚ä½•å˜åŒ–ï¼Œè¯¥ç»„ä»¶å¯¹è±¡éƒ½ä¸ä¼šå› ä¸ºäº‹ä»¶å˜åŒ–è€Œæ›´æ–°äº†

### vue3ç¼–è¯‘ä¼˜åŒ–æ€»ç»“

|ä¼˜åŒ–æ‰‹æ®µ|ç®€ä»‹|ä¼˜ç‚¹|
|-|-|-|
|Blockæ ‘ä¸åŠ¨æ€ç»“ç‚¹æ”¶é›†|å°†æ ¹ç»“ç‚¹ã€ç»“æ„æŒ‡ä»¤ç»“ç‚¹ä½œä¸ºBlockï¼Œä»¥Blockä¸ºå•ä½è¿›è¡ŒåŠ¨æ€ç»“ç‚¹æ”¶é›†|ç®€åŒ–HTMLæ ‘ç»“æ„ï¼Œé™ä½éå†éš¾åº¦ã€å¯¹æ¯”éš¾åº¦|
|é™æ€æå‡|å°†é™æ€ç»“ç‚¹çš„ä¿¡æ¯æå‡åœ¨renderå‡½æ•°ä¹‹å¤–|ä¸ä¼šé‡å¤æ¸²æŸ“é™æ€ç»“ç‚¹ä¿¡æ¯ï¼Œæé«˜æ€§èƒ½|
|å†…è”äº‹ä»¶ä¼˜åŒ–|renderå‡½æ•°å­˜å‚¨çš„æ˜¯äº‹ä»¶çš„æŒ‡é’ˆï¼Œå¯¹åº”äº‹ä»¶ä¼šè¢«ç¼“å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­|ç»„ä»¶å¯¹è±¡ä¸ä¼šåº”è¯¥ç»å¸¸å˜åŒ–çš„äº‹ä»¶è€Œé¢‘ç¹æ›´æ–°äº†|

## æ¸²æŸ“æ¨¡å—

> æ¯ä¸ªç»„ä»¶å®ä¾‹çš„renderå‡½æ•°ä¼šè¿”å›è¯¥ç»„ä»¶çš„è™šæ‹ŸDOM

æ¸²æŸ“å™¨çš„ä½œç”¨ç®€å•æ¥è¯´å°±æ˜¯è®©è™šæ‹ŸDOMå˜ä¸ºçœŸå®DOM

![](https://oss.justin3go.com/blogs/%E6%B8%B2%E6%9F%93%E5%99%A8%E8%BF%87%E7%A8%8B.png)

### è™šæ‹ŸDOMæ¦‚å¿µ

æœç´¢å’Œæ›´æ–°æ•°åƒä¸ªDOMèŠ‚ç‚¹å¾ˆæ˜æ˜¾ä¼šå˜æ…¢ï¼Œè¿™å°±æ˜¯Vueå’Œå…¶ä»–ç±»ä¼¼æ¡†æ¶çš„ä½œç”¨----[Virtual DOM](https://cn.vuejs.org/guide/extras/rendering-mechanism.html#virtual-dom)

Virual Nodeæ˜¯ä¸€ä¸ªJavaScriptå¯¹è±¡ï¼ŒVueçŸ¥é“å¦‚ä½•ä½¿ç”¨è¿™äº›Virtual Nodeå¹¶æŒ‚è½½å¾…DOMä¸Šï¼Œå®ƒä¼šæ›´æ–°æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸Šçœ‹åˆ°çš„å†…å®¹ï¼Œ**æ¯ä¸ªVNodeå¯¹åº”ä¸€ä¸ªDOMèŠ‚ç‚¹**ï¼ŒVueé€šè¿‡å¯»æ‰¾æ›´æ–°VNodeæœ€å°çš„æ›´æ–°æ•°é‡ï¼Œç„¶åå†å°†æœ€ä¼˜ç­–ç•¥æ–½åŠ åˆ°å®é™…DOMä¸­ï¼Œä»è€Œå‡å°‘DOMæ“ä½œï¼Œæé«˜æ€§èƒ½

å°±å¥½æ¯”åœ¨æ›´æ–°æ—¶å¯¹æ¯”æ–½å·¥å›¾çº¸ï¼Œæ‰¾åˆ°æœ€ä¼˜çš„æ›´æ–°ç­–ç•¥ï¼Œè€ŒéæŠŠæ•´æ ‹æ¥¼æ‹†äº†é‡å»ºï¼Œæˆ–è€…æ˜¯å»æ¥¼çš„å†…éƒ¨ä¸€ä¸€å¯¹æ¯”å“ªäº›ä¸åŒï¼Œå“ªäº›éœ€è¦æ›´æ–°è¿™æ ·è€—æ—¶è€—åŠ›ã€‚

> é™¤äº†åˆå§‹åŒ–è¿‡ç¨‹ä¸­Vueæ¡†æ¶ä¼šæŠŠ`HTML`æ¨¡æ¿ç¼–è¯‘ä¸ºVNodeï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨[hå‡½æ•°](https://cn.vuejs.org/guide/extras/render-function.html#creating-vnodes)ç”¨äºåˆ›å»ºVNode

ä¼˜ç‚¹ï¼š

- å®ƒè®©ç»„ä»¶çš„æ¸²æŸ“é€»è¾‘å®Œå…¨ä»çœŸå®DOMä¸­è§£è€¦
- æ›´ç›´æ¥åœ°å»é‡ç”¨æ¡†æ¶çš„è¿è¡Œåœ¨å…¶ä»–ç¯å¢ƒä¸­ï¼ŒVueè¿è¡Œç¬¬ä¸‰æ–¹å¼€å‘äººå‘˜åˆ›å»ºè‡ªå®šä¹‰æ¸²æŸ“è§£å†³æ–¹æ¡ˆï¼Œç›®æ ‡ä¸ä»…ä»…æ˜¯æµè§ˆå™¨ï¼Œä¹ŸåŒ…æ‹¬IOSå’ŒAndroidç­‰åŸç”Ÿç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨APIåˆ›å»ºè‡ªå®šä¹‰æ¸²æŸ“å™¨ç›´æ¥æ¸²æŸ“åˆ°WebGL,è€Œä¸æ˜¯DOMèŠ‚ç‚¹
- æä¾›äº†ä»¥ç¼–ç¨‹æ–¹å¼æ„é€ ã€æ£€æŸ¥ã€å…‹éš†ä»¥åŠæ“ä½œæ‰€éœ€çš„DOMæ“ä½œçš„èƒ½åŠ›

### Patchå‡½æ•°

Patchå‡½æ•°ä¸­ä½¿ç”¨äº†éå¸¸å¤šçš„åˆ†æ”¯ç»“æ„æ¥åº”å¯¹ä¸åŒçš„æƒ…å†µï¼Œæ¯”å¦‚å¯¹ç»è¿‡ç¼–è¯‘ä¼˜åŒ–æ‰“ä¸Šæ ‡è®°çš„ç»“ç‚¹å¯ä»¥è¿›è¡Œå¿«é€Ÿæ›´æ–°ï¼Œè€Œæ›´æ–°æ—¶ä¹Ÿæœ‰ä¸åŒçš„å…ƒç´ ç±»å‹ï¼Œå±æ€§ï¼Œç»“æ„ç­‰éƒ½æœ‰ä¸åŒçš„åˆ†æ”¯ç»“æ„è°ƒç”¨ä¸åŒçš„APIè¿›è¡Œå¤„ç†ã€‚

ç¯‡å¹…å’Œç²¾åŠ›æœ‰é™ï¼Œè¿™é‡Œä¸å¯èƒ½ä¹Ÿæ²¡å¿…è¦è¿›è¡Œå®Œæ•´çš„ä»‹ç»ï¼Œæˆ‘ç†è§£è¿™éƒ¨åˆ†åªéœ€è¦è®¤è¯†`Patch()`å‡½æ•°æ˜¯å¹²å˜›çš„å°±OKäº†ï¼Œå›ºä»…å¯¹å…¶æ¯”è¾ƒç»å…¸çš„Diffç®—æ³•è¿›è¡Œè¯¦ç»†ä»‹ç»

> [æºç ä½ç½®](https://github.com/vuejs/core/blob/main/packages/runtime-core/src/renderer.ts#L357)ï¼Œæœ‰å…´è¶£æˆ–è€…æƒ³æ±‚è¯çš„å¯ä»¥ç§ç§....

å¦‚ä¸‹æ˜¯ä¸€ä¸ªç»è¿‡ç®€åŒ–ï¼ˆä¸è€ƒè™‘ç¼–è¯‘ä¿¡æ¯ï¼Œå‡å°‘ç±»å‹åˆ†æ”¯ï¼‰çš„`patch()`å‡½æ•°ï¼Œå‚è€ƒè‡ª[creating-a-patch-function](https://www.vuemastery.com/courses/vue3-deep-dive-with-evan-you/creating-a-patch-function)

```js{6}
<div id="app"></div>

<script>
// n1æ˜¯æ—§çš„è™šæ‹ŸDOMï¼Œä¹‹å‰çš„å¿«ç…§ï¼Œn2æ˜¯æ–°çš„è™šæ‹ŸDOMï¼Œæ˜¯æˆ‘ä»¬ç°åœ¨æƒ³è¦å±•ç¤ºåœ¨ç•Œé¢çš„éƒ¨åˆ†
// patchéœ€è¦æ‰¾å‡ºæœ€å°æ•°é‡å®ƒéœ€è¦æ‰§è¡Œçš„DOMæ“ä½œ
function patch(n1, n2){
    // è¿™é‡Œä»…è®¨è®ºç›¸åŒç±»å‹éœ€è¦åšçš„å·¥ä½œ
    if(n1.tag === n2.tag){
        // ä¸­é—´è¿™éƒ¨æ˜¯ä¸ºäº†åœ¨ä»¥åçš„æ›´æ–°ä¸­æˆä¸ºæœªæ¥çš„å¿«ç…§
        const el = n2.el = n1.el
        // props 
        // è¿™é‡Œä¸è®¨è®ºn1,n2çš„propsæ˜¯å¦ä¸ºç©ºçš„å››ç§åˆ†æ”¯æƒ…å†µ
        const oldProps = n1.props || {}
        const newProps = n2.props || {}
        for(const key in newProps){
            const oldValue = oldProps[key]
            const newValue = newProps[key]
            // åªæœ‰åœ¨å®é™…å˜åŒ–åæ‰ä¼šè°ƒç”¨ï¼Œä»¥æœ€å°åŒ–å®é™…DOM APIçš„è°ƒç”¨
            if(newValue !== oldValue){
                // æ—§çš„æ²¡æœ‰ï¼Œsetä¼šæ·»åŠ ï¼Œæ—§çš„æœ‰keyï¼Œsetä¼šæ›¿æ¢
                el.setAttribute(key, newValue)
            }
        }
        // æ¥ä¸‹æ¥è®¨è®ºkeyä¸åœ¨newPropsä¸­çš„æ—¶å€™
        for (const key in oldProps){
            if(!(key in oldProps)){
                el.removeAttribute(key)
            }
        }
        
        // children
        const oldChildren= n1.children
        const newChildren = n2.children
        if(typeof newChildren === 'string'){
            if(typeof oldChildren === 'string'){
                if(newChildren !== oldChildren){
                    el.textContent = newChildren
                }
            }else{
                // ä½¿ç”¨æ–‡æœ¬ç›´æ¥è¦†ç›–ç°æœ‰çš„DOMèŠ‚ç‚¹å¹¶ä¸¢å¼ƒå®ƒä»¬
                el.textContent = newChildren
            }
        }else{  // newCæ˜¯arrçš„æƒ…å†µ
            if(typeof oldChildren === 'string'){
                el.innreHTML = ''  // æ¸…ç†ï¼Œç„¶åè¿™ä¸ªå…ƒç´ å˜ä¸ºç©ºå…ƒç´ 
                // åŠ å…¥
                newChildren,forEach(child => {
                    mount(child, el)
                })
            }else{  // éƒ½æ˜¯æ•°ç»„çš„æƒ…å†µ
				// ç•¥...
            }
        }
    }else{
        // other case
    }
}

// æ¼”ç¤º
function mount(vnode, container){
	// ç•¥
}
    
const vdom = h('div', {class: 'red'},[
    h('span', null, ['hello'])
])
mount(vdom, document.getElementById("app"))

const vdom2 = h('div', {class: 'green'},[
    h('span', null, ['changed'])
])
patch(vdom, vdom2)
</script>
```

### Diffç®—æ³•

å½“æˆ‘ä»¬é‡åˆ°æ–°æ—§èŠ‚ç‚¹éƒ½åŒ…å«å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå³ä¸¤ä¸ªæ•°ç»„éœ€è¦å¯¹æ¯”ï¼Œåˆæ²¡æœ‰å…¶ä»–å¿«æ·æ›´æ–°çš„ä¿¡æ¯æ—¶ï¼Œå°±ä¸å¾—ä¸è¿›è¡Œ`full diff`ï¼Œå…³äºè¯¥éƒ¨åˆ†Vueé€šè¿‡[`patchKeyedChildren()`å‡½æ•°](https://github.com/vuejs/core/blob/main/packages/runtime-core/src/renderer.ts#L1751)è¿›è¡Œäº†å®ç°ã€‚

*æ³¨ï¼šæ¥ä¸‹æ¥çš„ç®—æ³•è®²è§£ä¾‹å­å°†è„±ç¦»æ¡†æ¶è¿è¡Œç¯å¢ƒï¼ŒæŠ½è±¡ä¸ºçº¯ç²¹çš„**æ–°æ—§ä¸¤ä¸ªæ•°ç»„è¿›è¡ŒåŒæ­¥ï¼Œæ‰¾å‡ºæœ€å°‘çš„æ›´æ–°æ­¥éª¤**çš„ä¸€ä¸ªç®—æ³•é—®é¢˜ã€‚*

é¡ºä¾¿å†æä¸€ä¸‹ï¼šä¹‹æ‰€ä»¥éœ€è¦æ‰¾åˆ°æœ€ä¼˜çš„æ›´æ–°ç­–ç•¥ï¼Œæ˜¯å› ä¸ºå®é™…DOMæ“ä½œè¿œæ¯”JSçš„æ•°ç»„æ¯”è¾ƒè€—æ—¶ï¼Œè¿™å°±æ˜¯è™šæ‹ŸDOMä½œä¸ºå®é™…DOMçš„è®¾è®¡å›¾çº¸ä¼˜åŠ¿ä¹‹ä¸€ã€‚

#### Keyçš„ä½œç”¨

æ¡†æ¶é€šè¿‡åˆ¤æ–­ç»“ç‚¹çš„keyå€¼å’Œç»“ç‚¹ç±»å‹ï¼Œä»è€Œç¡®è®¤æ–°æ—§ç»“ç‚¹æ˜¯å¦æ˜¯å¯ä»¥å¤ç”¨çš„ç»“ç‚¹--"ç»“ç‚¹æ˜¯å¦ç›¸åŒ"ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šDOMå¯å¤ç”¨å¹¶ä¸æ„å‘³ç€ä¸éœ€è¦æ›´æ–°ï¼Œæ¯”å¦‚æ–‡æœ¬ç»“ç‚¹çš„æ–‡æœ¬ä¸åŒï¼Œåªæ˜¯æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨åŒä¸€ç»“ç‚¹ä¸Šè¿›è¡Œpatchæ“ä½œï¼Œè€Œä¸éœ€è¦ç§»åŠ¨ã€å¢ã€åˆ ç»“ç‚¹ã€‚

> å¯ä»¥å‚è€ƒ[è¿™éƒ¨åˆ†ä»£ç å®ç°](https://github.com/vuejs/core/blob/main/packages/runtime-core/src/vnode.ts#L367)

#### 1-4é¢„å¤„ç†

åŸºæœ¬æ€æƒ³éå¸¸ç®€å•ï¼Œ**å°±æ˜¯åœ¨æ­£å¼å¤„ç†ä¹‹å‰ï¼Œå…ˆå¤„ç†å¤´å°¾ç›¸åŒçš„éƒ¨åˆ†**ï¼Œè¿™éƒ¨åˆ†ç»“ç‚¹æ˜¯ç›¸åŒçš„ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œpatchæ“ä½œï¼Œä¸éœ€è¦ç§»åŠ¨ç»“ç‚¹é¡ºåºã€‚

å¦‚ä¸‹ä¸¤ä¸ªæ–°æ—§æ•°ç»„éœ€è¦è¿›è¡ŒåŒæ­¥ï¼Œå‡è®¾æ•°å­—ç›¸åŒè®¤ä¸ºç»“ç‚¹ç›¸åŒï¼š

```js
const oldNodes = [1,2,3,4, 5,6,7,8]
const newNodes = [1,2,3,4, 11,13,15, 5,6,7,8]
```

ç›¸ä¿¡è¿™ä¸ªé—®é¢˜å¯¹å¤§å®¶åº”è¯¥é—®é¢˜ä¸å¤§ï¼Œè¿™é‡Œç¬”è€…è´´åˆæºç æ­¥éª¤ç®€å•å®ç°ä¸€ä¸‹ä¾›å¤§å®¶å‚è€ƒï¼š

1. sync from startï¼šåŒæ­¥æ›´æ–°å¼€å§‹éƒ¨åˆ†ç»“ç‚¹ç›¸åŒçš„
2. sync from endï¼šåŒæ­¥æ›´æ–°ç»“æŸéƒ¨åˆ†ç»“ç‚¹ç›¸åŒçš„
3. common sequence + mountï¼šæ— å‰©ä½™æœªå¤„ç†æ—§ç»“ç‚¹ï¼Œä½†å‰©æœ‰æ–°çš„ç»“ç‚¹ï¼Œæ‰§è¡ŒæŒ‚è½½æ“ä½œ
4. common sequence + unmountï¼šæœ‰å‰©ä½™æœªå¤„ç†æ—§ç»“ç‚¹ï¼Œæ— å‰©ä½™æœªå¤„ç†æ–°ç»“ç‚¹ï¼Œæ‰§è¡Œå¸è½½æ“ä½œ

```js
/**
 * @param {number[]} oldNodes
 * @param {number[]} newNodes
 */
function preProcess(oldNodes, newNodes){
    // * åˆå§‹åŒ–
    let i = 0;  // ä¸¤ä¸ªæ•°ç»„éå†å¼€å§‹çš„ç´¢å¼•
    const newLen = newNodes.length;
    // ç”±äºä¸¤ä¸ªæ•°ç»„å¼€å§‹ä½ç½®éƒ½ç”±iæ§åˆ¶ï¼Œä½†ä¸¤æ•°ç»„å¯èƒ½é•¿åº¦ä¸åŒï¼Œæ•…è¿™é‡Œç”¨ä¸¤ä¸ªæŒ‡é’ˆæ§åˆ¶ä¸¤æ•°ç»„çš„ç»“æŸä½ç½®
    let oldEndPos = oldNodes.length - 1;
    let newEndPos = newNodes.length - 1;

    while(i <= oldEndPos && i <= newEndPos) {
        const oldNode = oldNodes[i];
        const newNode = newNodes[i];
        if(oldNode === newNode) {
            console.log(`startéƒ¨åˆ†æ‰§è¡Œpatch(oldNode, newNode)`);
        } else break;
        i++;
    }

    console.log(`ä»å‰å¾€åé¦–æ¬¡ä¸¤ä¸ªç»“ç‚¹ä¸ç›¸åŒçš„åæ ‡ä¸ºï¼š${i}`);

    while(i <= oldEndPos && i <= newEndPos) {
        const oldNode = oldNodes[oldEndPos];
        const newNode = newNodes[newEndPos];
        if(oldNode === newNode) {
            console.log(`endéƒ¨åˆ†æ‰§è¡Œpatch(oldNode, newNode)`);
        } else break;
        oldEndPos--;
        newEndPos--;
    }

    console.log(`ä»åå¾€å‰é¦–æ¬¡ä¸¤ä¸ªç»“ç‚¹ä¸ç›¸åŒçš„åæ ‡ä¸º oldï¼š${oldEndPos}; newï¼š${newEndPos}`);

    // æ‰§è¡Œå®Œä¸Šè¿°æ“ä½œï¼Œå¯èƒ½å‡ºç°ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼Œå°±æ˜¯æœ‰å¯èƒ½æ–°æ—§æ•°ç»„å¯èƒ½æŸä¸€æ–¹è¢«å¤„ç†å®Œäº†ï¼ˆæ— å‰©ä½™ç»“ç‚¹ï¼‰
    // æ­¤æ—¶å°±å¯ä»¥æ‰§è¡Œå…¨éƒ¨æŒ‚è½½å’Œå…¨éƒ¨å¸è½½çš„æ“ä½œã€‚ç®€å•æ¥è¯´å°±æ˜¯æœ‰ä¸€æ–¹ä¸æ˜¯æ•°ç»„äº†ï¼Œä¸éœ€è¦å†å¯¹ä¸¤ä¸ªæ•°ç»„è¿›è¡Œå¯¹æ¯”äº†ã€‚

    if(i > oldEndPos) {  // æ—§ç»“ç‚¹æ•°ç»„è¢«å¤„ç†å®Œäº†
        if(i <= newEndPos) {  // æ–°ç»“ç‚¹æ•°ç»„è¿˜æœ‰å‰©ä½™
            // æ‰§è¡ŒæŒ‚è½½æ“ä½œï¼Œæ–°çš„è®¾è®¡å›¾çº¸è¡¨æ˜è¦å¢åŠ ï¼Œæ‰€ä»¥è¿™é‡Œè¿™é‡Œè¦åœ¨æ–½å·¥åœºåœ°åšå¢åŠ æ“ä½œ
            console.log(`å°†${newNodes.slice(i, newEndPos + 1)}æŒ‚è½½åˆ°çœŸå®ç¯å¢ƒä¸­`);
        }
    } else if (i > newEndPos) {  // æ–°ç»“ç‚¹æ•°ç»„è¢«å¤„ç†å®Œäº†ï¼Œelseè¡¨ç¤ºæ—§ç»“ç‚¹è¿˜æœ‰å‰©ä½™
        console.log(`å°†${oldNodes.slice(i, oldEndPos + 1)}ä»çœŸå®ç¯å¢ƒä¸­å¸è½½`);
    } else {
        console.log(`å‰©ä¸‹çš„æ–°æ—§èŠ‚ç‚¹æ•°ç»„éƒ½ä¸ä¸ºç©º[unknown sequence]`);
        // æºç æ˜¯åœ¨è¿™é‡Œè¿›è¡Œä¹±åºåºåˆ—å¤„ç†çš„ï¼Œä¸è¿‡è¿™é‡Œä¸ºäº†æ–¹ä¾¿åˆ†æ­¥è¿è¡Œæ¼”ç¤ºï¼Œå°±æŠ›å‡ºåæ ‡ç»™åç»­å‡½æ•°å¤„ç†
    }

    return [i, oldEndPos, newEndPos];
}
```

é¢„å¤„ç†ä»£ç éå¸¸ç®€å•ï¼Œä¸è¿‡èƒ½åœ¨è¯¥æƒ…æ™¯æƒ³åˆ°è¿™æ ·çš„å¤„ç†å´æ˜¯éå¸¸å·§å¦™ï¼Œä¸‹æ–¹ä¸ºä¸Šæ–¹å‡½æ•°çš„è¿è¡Œæ•ˆæœï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å¤åˆ¶ä¸Šæ–¹ä»£ç è‡ªè¡Œå°è¯•ï¼š

```js
console.log(`é¢„å¤„ç†ç»“æœä¸º${preProcess([1,2,3,4, 5,6,7,8], [1,2,3,4, 11,13,15, 5,6,7,8])}`);
console.log(`é¢„å¤„ç†ç»“æœä¸º${preProcess([1,2,3,4, 11,13,15, 5,6,7,8], [1,2,3,4, 5,6,7,8])}`);
```

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230202233312.png)

#### 5. å¤„ç†ä¹±åºåºåˆ—

åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬ç»§ç»­æ˜ç¡®æˆ‘ä»¬éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œè„±ç¦»APIï¼ŒæŠ½è±¡ä¸ºä¸€ä¸ªç®—æ³•é—®é¢˜å°±æ˜¯ï¼šä¸¤ä¸ªä¹±åºæ–°æ—§æ•°ç»„ï¼Œå¦‚ä½•å°½å¯èƒ½å¤šçš„å¤ç”¨æ—§æ•°ç»„çš„ç»“ç‚¹å®Œæˆåˆ°æ–°æ•°ç»„çš„æ›´æ–°

*æ³¨ï¼šå›åˆ°æµè§ˆå™¨ç¯å¢ƒä¸­æ˜¯ä¾æ®æ–°æ—§æ•°ç»„çš„æœ€ä¼˜æ›´æ–°ç­–ç•¥æ“ä½œçœŸå®çš„DOMæ•°ç»„*

åŒæ ·è¿™é‡Œä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œä»¥æ•°å­—ä»£è¡¨è™šæ‹Ÿç»“ç‚¹ï¼Œ**å¹¶å‡è®¾æ•°å­—ç›¸åŒè®¤ä¸ºç»“ç‚¹ç›¸åŒï¼ˆå³keyä¹Ÿç›¸åŒï¼‰**ï¼Œæ¯”å¦‚å‡è®¾ä¸‹æ–¹æ•°æ®ä¸ºé¢„å¤„ç†ä¹‹åçš„æ•°æ®ï¼š

```js
const oldNodes = [11,12,13,14,15,16,17]
const newNodes = [14,11,12,16,13,15,18]
// å…¶ä¸­11,12,13,14,15,16è¿™ç±»ç»“ç‚¹å¯ä»¥ç›´æ¥é€šè¿‡ç§»åŠ¨å®Œæˆæ›´æ–°
// è€Œ17åœ¨æ–°æ•°ç»„æœªå‡ºç°ï¼Œæ•…éœ€è¦åœ¨çœŸå®DOMæ•°ç»„ä¸­å¸è½½è¯¥ç»“ç‚¹
// 18åœ¨æ—§æ•°ç»„æœªå‡ºç°ï¼Œæ•…éœ€åˆ›å»ºè¯¥ç»“ç‚¹å¹¶æŒ‚è½½åˆ°çœŸå®DOMæ•°ç»„ä¸­
```

è¿™æ­¥ç›¸å¯¹äºé¢„å¤„ç†æ¥è¯´æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯å†å¤æ‚çš„é—®é¢˜æ‹†è§£ä¸ºæ¯ä¸€å°æ­¥ä¹‹åå°±æ›´åŠ å®¹æ˜“ç†è§£äº†ï¼Œæºç éƒ¨åˆ†ä¹Ÿæœ‰å…³é”®çš„æ³¨é‡Šå°†[è¿™æ­¥](https://github.com/vuejs/core/blob/main/packages/runtime-core/src/renderer.ts#L1864)åˆ†ä¸ºäº†3å°æ­¥

##### ç¡®å®šæ–°ç»“ç‚¹ä½ç½®ï¼ˆ5.1+5.2ï¼‰

**1ï¼‰åšä»€ä¹ˆ**

è¿˜æ˜¯ç»å…¸çš„æ€è·¯ï¼Œå…ˆç¡®å®šè¿™æ­¥è¦åšä»€ä¹ˆï¼šæ„é€ ä¸€ä¸ªæ–°æ•°ç»„å„ç»“ç‚¹ä½ç½®åœ¨æ—§æ•°ç»„ä¸­å„ç»“ç‚¹ä½ç½®çš„ä¸€ä¸ªå¯¹åº”å…³ç³»`newIndexToOldIndexMap`ã€‚

*æ„é€ è¿™ä¸ªç»“æ„æ˜¯ä¸ºäº†åç»­æ–¹ä¾¿æ±‚æœ€é•¿é€’å¢å­åºåˆ—ï¼Œå…·ä½“åŸå› åœ¨é‚£å°èŠ‚è¯¦ç»†ä»‹ç»ã€‚*

```js
// oldå¯¹åº”ä½ç½®ç´¢å¼•ä¸º[(11=>0),(12=>1),(13=>2),(14=>3),(15=>4),(16=>5),(17=>6)]
const oldNodes = [11,12,13,14,15,16,17]
```

ç„¶åé€šè¿‡åˆ¤æ–­ç»“ç‚¹keyæ˜¯å¦ç›¸åŒï¼Œè¿™é‡Œå‡è®¾çš„æ˜¯æ•°å­—æ˜¯å¦ç›¸åŒï¼Œä»è€Œç¡®å®šæ–°ç»“ç‚¹æ•°ç»„åœ¨æ—§ç»“ç‚¹æ•°ç»„ä¸­çš„ä½ç½®ç´¢å¼•ï¼š

![](https://oss.justin3go.com/blogs/%E7%A1%AE%E5%AE%9A%E6%96%B0%E8%99%9A%E6%8B%9F%E7%BB%93%E7%82%B9%E6%95%B0%E7%BB%84%E4%BD%8D%E7%BD%AE.png)

è¯¥ä¾‹å­ä¸­çš„`newIndexToOldIndexMap = [3, 0, 1, 5, 2, 4, -1]`

æ˜ç™½äº†éœ€è¦åšä»€ä¹ˆï¼Œæ¥ä¸‹æ¥è¿™æ­¥ç®—æ³•çš„å®ç°ç›¸å¯¹æ¥è¯´ä¹Ÿä¸éš¾

**2ï¼‰é™ä½ç®—æ³•å¤æ‚åº¦**

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šåŒæ ·è¿™é‡Œä¹Ÿæ˜¯é€šè¿‡éå†è¿™ä¸¤ä¸ªæ•°ç»„æ¥å¡«å……`newIndexToOldIndexMap`ï¼Œå³æš´åŠ›è§£æ³•çš„ç®—æ³•å¤æ‚åº¦ä¸º:
$$O(n^2)$$
æ‰€ä»¥ä¸ºäº†ä¼˜åŒ–è¿™é‡Œåˆ©ç”¨äº†**ç©ºé—´æ¢æ—¶é—´**æ€æƒ³ã€‚ä½¿ç”¨`keyToNewIndexMap`å…ˆå­˜å‚¨äº†æ–°èŠ‚ç‚¹æ•°ç»„çš„å…³é”®ä¿¡æ¯ï¼š

```js
// ä¼ªä»£ç è¡¨ç¤ºç»“æœå¦‚ä¸‹
const keyToNewIndexMap = {(14=>0),(11=>1),(12=>2),(16=>3),(13=>4),(15=>5),(18=>6)}
```

ä¹‹ååœ¨éå†æ—§ç»“ç‚¹æ•°ç»„æ—¶ï¼Œå°±å¯ä»¥åœ¨`O(1)`çš„å¤æ‚åº¦é€šè¿‡æ—§ç»“ç‚¹çš„keyç›´æ¥è·å–æ–°ç»“ç‚¹çš„ä½ç½®ï¼Œè€Œéæ¯æ¬¡éƒ½åœ¨å†…éƒ¨åµŒå¥—å¾ªç¯éå†æ–°ç»“ç‚¹æ•°ç»„å»é‡æ–°è·å–å¯¹åº”æ–°èŠ‚ç‚¹ä½ç½®ï¼Œæœ€ç»ˆæ„é€ `newIndexToOldIndexMap`çš„ç®—æ³•å¤æ‚åº¦é™åˆ°äº†
$$O(n)$$

**3ï¼‰ä»£ç å®ç°**

> `pos`å˜é‡è¡¨ç¤ºï¼šåœ¨æ—§ children ä¸­å¯»æ‰¾å…·æœ‰ç›¸åŒ key å€¼èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°çš„æœ€å¤§ç´¢å¼•å€¼ã€‚å¦‚æœåœ¨åç»­å¯»æ‰¾çš„è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ç´¢å¼•å€¼æ¯”å½“å‰é‡åˆ°çš„æœ€å¤§ç´¢å¼•å€¼è¿˜è¦å°çš„èŠ‚ç‚¹ï¼Œåˆ™æ„å‘³ç€è¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨`moved=true`

```js
/**
 * @param {number[]} oldNodes 
 * @param {number[]} newNodes 
 * @param {number} j ä¸Šéƒ¨åˆ†ä¼ é€’è¿‡æ¥çš„i
 * @param {number} newEndPos 
 * @param {number} oldEndPos 
 */
function buildMap(oldNodes, newNodes, j, newEndPos, oldEndPos) {
    const oldStartPos = j
    const newStartPos = j
    // æ„é€ keyToNewIndexMapç´¢å¼•è¡¨
    const keyToNewIndexMap = {}
    for (let i = newStartPos; i <= newEndPos; i++) {
        keyToNewIndexMap[newNodes[i]] = i
    }

    // æ„é€  newIndexToOldIndexMap æ•°ç»„
    const count = newEndPos - j + 1
    const newIndexToOldIndexMap = new Array(count).fill(-1)

    let moved = false
    let pos = 0  // è®°å½•å¯»æ‰¾è¿‡ç¨‹ä¸­é‡åˆ°çš„æœ€å¤§ç´¢å¼•å€¼
    let patched = 0  // è¡¨ç¤ºæ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡
    for (let i = oldStartPos; i <= oldEndPos; i++) {
        const oldNode = oldNodes[i]
        // å¦‚æœæ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡å°äºç­‰äºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ï¼Œåˆ™æ‰§è¡Œæ›´æ–°
        if (patched <= count) {
            const k = keyToNewIndexMap[oldNode]  // é€šè¿‡æ—§ç»“ç‚¹çš„keyæ‰¾åˆ°æ–°ç»“ç‚¹çš„ä½ç½®
            if (typeof k !== 'undefined') {
                const newNode = newNodes[k]
                console.log(`i=${i},æ‰§è¡Œpatch(${oldNode}, ${newNode})`);
                // æ¯æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½å°† patched +1
                patched++
                newIndexToOldIndexMap[k - newStartPos] = i  // å¡«å……
                if (k < pos) {
                    moved = true
                } else {
                    pos = k
                }
            } else {
                console.log(`i=${i}ï¼Œæ²¡æ‰¾åˆ°:unmount(${oldNode})`);
            }
        } else {
            // å¦‚æœæ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡å¤§äºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ï¼Œåˆ™å¸è½½å¤šä½™çš„èŠ‚ç‚¹
            console.log(`i=${i}ï¼Œå¸è½½å¤šä½™çš„èŠ‚ç‚¹:unmount(${oldNode})`);
        }
    }
    
    return [moved, newIndexToOldIndexMap];
}
```

è¿è¡Œä»£ç æ¼”ç¤ºå¦‚ä¸‹ï¼š

```js
console.log(buildMap([11, 12, 13, 14, 15, 16, 17], [14, 11, 12, 16, 13, 15, 18], 0, 6, 6));
```

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230203195703.png)

##### æœ€é•¿é€’å¢å­åºåˆ—å®Œæˆæœ€ä¼˜æ›´æ–°ï¼ˆ5.3ï¼‰

è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦`newIndexToOldIndexMap`ï¼Œè¯¥ç»“æ„è®°å½•çš„æ—¶æ–°æ•°ç»„å„ç»“ç‚¹ä½ç½®åœ¨æ—§æ•°ç»„ä¸­å„ç»“ç‚¹ä½ç½®çš„ä¸€ä¸ªå¯¹åº”å…³ç³»ã€‚è¿™ä¸ªç»“æ„ä¸­æ•°ç»„ä¸‹æ ‡å¯¹åº”æ—§ç»“ç‚¹ï¼Œæ•°ç»„å€¼å¯¹åº”æ–°ç»“ç‚¹ã€‚å¦‚`[3,0,1,5,2,4,-1]`ä¸­`(0=>3),(1=>0),(2=>1),(3=>5),(4=>2),(5=>4)`

æœ€é•¿é€’å¢å­åºåˆ—ï¼šå°±æ˜¯åå­—çš„æ„æ€ï¼Œé€’å¢å­åºåˆ—ä¸­æœ€é•¿çš„é‚£ä¸€ä¸ª

è€Œæˆ‘ä»¬çš„æ€»ç›®æ ‡å°±æ˜¯è¦æ‰¾åˆ°æœ€å°‘çš„ç§»åŠ¨æ¬¡æ•°ï¼Œè€Œæ—§æ•°ç»„çš„ä½ç½®ç´¢å¼•åœ¨`newIndexToOldIndexMap`æ˜¯é€’å¢çš„é¡ºåºï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°æ–°ç»“ç‚¹æ•°ç»„çš„æœ€é•¿çš„é€’å¢çš„ç»“ç‚¹ä»¬ï¼Œå°±èƒ½æ‰¾åˆ°æœ€ä¼˜çš„ç§»åŠ¨ç­–ç•¥ï¼Œç„¶åè¿›è¡Œç§»åŠ¨å°±å¯ä»¥äº†ï¼Œå¦‚å›¾ï¼š

![](https://oss.justin3go.com/blogs/%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97%E7%A7%BB%E5%8A%A8%E7%AD%96%E7%95%A5.png)

ä¸Šå›¾æ–°èŠ‚ç‚¹çš„æœ€é•¿é€’å¢å­åºåˆ—çš„`[1,2,4]`ï¼Œå³å›¾ä¸­ç™½è‰²èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨ï¼Œæ‰€ä»¥è¯¥ç§»åŠ¨ç­–ç•¥çš„ç§»åŠ¨æ¬¡æ•°ä¸º3æ¬¡ã€‚

æ¨èé“¾æ¥ï¼š

- [æºä»£ç é“¾æ¥](https://github.com/vuejs/core/blob/bef85e7975084b05af00b60ecd171c83f251c6d5/packages/runtime-core/src/renderer.ts#L2403)ï¼Œè¿™æ˜¯çº¯ç²¹çš„ç®—æ³•å®ç°ï¼Œè¿™é‡Œç¬”è€…å°±ä¸é‡å¤å®ç°äº†...
- [ç®—æ³•é¢˜é“¾æ¥](https://leetcode.cn/problems/longest-increasing-subsequence/)ï¼ŒåŠ›æ‰£ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¸¸è§„çš„ä¸­ç­‰é¢˜ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥ç»ƒç»ƒæ‰‹...

æœ€åå°±æ˜¯è¿›è¡Œç»“ç‚¹çš„ç§»åŠ¨äº†ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¹Ÿæ²¡ä»€ä¹ˆç‰¹åˆ«çš„é€»è¾‘ã€ç•¥ã€‘

### æ€»ç»“

- è™šæ‹ŸDOMï¼šè§£è€¦çœŸå®ç¯å¢ƒï¼Œæé«˜æ›´æ–°æ€§èƒ½ï¼Œæé«˜å„å¹³å°å…¼å®¹æ€§
- Patchå‡½æ•°ï¼šæ›´æ–°èŠ‚ç‚¹æ—¶ä½¿ç”¨
- Diffç®—æ³•ï¼šé¢„å¤„ç†+ç©ºé—´æ¢æ—¶é—´+æœ€é•¿é€’å¢å­åºåˆ—

## å“åº”å¼

å“åº”å¼è¿™å—å°±æˆ‘è€Œè¨€æ˜¯çœ‹åˆ°ç½‘ä¸Šæ–‡ç« å‡ºç°é¢‘ç‡æœ€å¤šçš„ä¸€ä¸ªæ¨¡å—äº†ï¼Œå®ƒå°±æ˜¯çŠ¶æ€æ•°æ®ä¸è§†å›¾åŒå‘ç»‘å®šçš„å…·ä½“å®ç°äº†ã€‚

==å…·ä½“ä»£ç ç»†èŠ‚ç¬”è€…è¿™é‡Œä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œæœ‰ç‚¹è‚ä¸åŠ¨äº†ï¼Œä¸»è¦èµ°èµ°å“åº”å¼ç³»ç»Ÿçš„è¿è¡Œè¿‡ç¨‹==

### å“åº”å¼æ¦‚å¿µ

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª[todoListåº”ç”¨](https://github.com/vuejs/core/blob/main/packages/vue/examples/composition/todomvc.html)ï¼Œå…¶ä¸­çš„æ‰€æœ‰äº‹é¡¹æˆ‘ä»¬è®¾ç½®ä¸ºå“åº”å¼æ•°æ®ï¼Œå½“ç”¨æˆ·å¢åˆ æ”¹äº‹é¡¹æ—¶ï¼Œæˆ‘ä»¬ä½œä¸ºå¼€å‘è€…åªéœ€ä¿®æ”¹å¯¹åº”æ•°æ®å°±å¯ä»¥äº†ï¼Œè‡³äºåç»­é¡µé¢äº‹é¡¹åˆ—è¡¨çš„é‡æ–°æ¸²æŸ“æ˜¯é€šè¿‡å“åº”å¼æ¨¡å—è‡ªåŠ¨è§¦å‘çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ¡†æ¶çš„åŸå› ä¹‹ä¸€ã€‚

![](https://oss.justin3go.com/blogs/%E5%93%8D%E5%BA%94%E5%BC%8F%E6%9B%B4%E6%96%B0%E8%BF%87%E7%A8%8B.png)

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ‰“å¼€è¿™ä¸ªé»‘ç›’ç§ç§...

### ä¸»è¦å·¥ä½œæµç¨‹

**1ï¼‰å“åº”å¼ç®€å•ç†è§£å°±ä¸¤æ­¥ï¼š`track` + `trigger`ï¼Œä¸­æ–‡å«ä¹‰ä¸ºè·Ÿè¸ª+è§¦å‘:**

1. è·Ÿè¸ª(track)ï¼šå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ä¾èµ–æ”¶é›†ï¼Œå¯¹äºå“åº”å¼æ•°æ®ï¼Œæ‰¾åˆ°ä¾èµ–äºè¯¥æ•°æ®çš„[å‰¯ä½œç”¨å‡½æ•°](https://baike.baidu.com/item/%E5%87%BD%E6%95%B0%E5%89%AF%E4%BD%9C%E7%94%A8/22723425)ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªæ–¹ä¾¿çš„å­˜å‚¨ç»“æ„å­˜å‚¨å¯¹åº”å…³ç³»
2. è§¦å‘(trigger)ï¼šå½“æˆ‘ä»¬ç›‘å¬åˆ°å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œå°±åœ¨ä¹‹å‰æ”¶é›†çš„å­˜å‚¨æ¡¶é‡Œé¢æ‰¾åˆ°ç›¸å…³è”çš„[å‰¯ä½œç”¨å‡½æ•°](https://baike.baidu.com/item/%E5%87%BD%E6%95%B0%E5%89%AF%E4%BD%9C%E7%94%A8/22723425)ï¼Œç„¶åæ‰§è¡Œå°±å¯ä»¥äº†

**2ï¼‰ä¸ºäº†è‡ªåŠ¨è§¦å‘ï¼Œä½¿ç”¨äº†[Proxy](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy)ä»£ç†å“åº”å¼å¯¹è±¡`ReactiveObject`:**

1. å°†trackå‡½æ•°æ”¾å…¥äº†[get](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get)ï¼Œå³ä½¿ç”¨è¯¥æ•°æ®æ—¶ä¼šè‡ªåŠ¨è§¦å‘`track()`
2. å°†triggerå‡½æ•°æ”¾å…¥äº†[set](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set)ï¼Œå³ä¿®æ”¹è¯¥æ•°æ®æ—¶ä¼šè‡ªåŠ¨è§¦å‘`trigger()`

**3ï¼‰ä¸ºäº†é¿å…ç¡¬ç¼–ç å‡½æ•°åï¼Œå³æ¯æ¬¡åœ¨trackæ—¶éƒ½å¿…é¡»çŸ¥é“å‰¯ä½œç”¨å‡½æ•°çš„åå­—**

- æˆ‘ä»¬ä½¿ç”¨äº†å…¨å±€å˜é‡`activeEffect`æ¥ä»£æ›¿ï¼Œå³trackå‡½æ•°æ¯æ¬¡æ”¶é›†`activeEffect`æŒ‡å‘çš„å‡½æ•°å³å¯
- ç„¶åé€šè¿‡`ReactiveEffect`æ³¨å†Œä¼ é€’è¿‡æ¥çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œå°†è¯¥`activeEffect`å˜é‡æŒ‡å‘è¯¥å‰¯ä½œç”¨å‡½æ•°

ä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹**ç¨å¾®å…·ä½“ä¸€ç‚¹çš„å·¥ä½œé“¾è·¯**ï¼Œå¦‚æœä½ æœ‰ä¸€å®šçš„æºç é˜…è¯»ç»éªŒæˆ–è€…å­¦ä¹ è¿‡å“åº”å¼åŸç†ï¼Œä¸‹æ–¹ç»“åˆä»£ç çš„å›¾å¯¹ä½ æ¥è¯´åº”è¯¥è½»è€Œæ˜“ä¸¾ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¹Ÿä¸ç”¨æ…Œå¼ ï¼Œæ¥ä¸‹æ¥ä¼šä¸€æ­¥æ­¥ä»‹ç»å…¶å·¥ä½œæµç¨‹ã€‚

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230204034327.png)

> [å‚è€ƒå›¾ç‰‡åŸæ–‡](https://juejin.cn/post/7145756356014768158)

**å·¥ä½œè¿‡ç¨‹ï¼š**

0. é¦–å…ˆæˆ‘ä»¬æœ‰ä¸€ä¸ªå“åº”å¼æ•°æ®`ReactiveObject{}`å’Œä¾èµ–äºè¯¥æ•°æ®çš„ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°`Effect()`
1. å°†æˆ‘ä»¬å‰¯ä½œç”¨å‡½æ•°ä¼ é€’åˆ°`ReactiveEffect`å‡½æ•°ä¸­
2. æ³¨å†Œè¯¥å‰¯ä½œç”¨å‡½æ•°ï¼Œå°†`activeEffect`å˜é‡æŒ‡å‘å®ƒ
3. æ‰§è¡Œè¯¥å‰¯ä½œç”¨å‡½æ•°
4. ç”±äºè¯¥å‰¯ä½œç”¨å‡½æ•°ä¾èµ–äºæˆ‘ä»¬çš„å“åº”å¼æ•°æ®`ReactiveObject`ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»ä¸º`ReactiveObject`è®¾ç½®äº†ä»£ç†æ‹¦æˆªæ“ä½œ`get`ï¼Œæ•…åœ¨è¯»å–è¯¥å€¼æ—¶ä¼šè‡ªåŠ¨è§¦å‘trackå‡½æ•°
5. trackå‡½æ•°æ‰¾åˆ°`activeEffect`å˜é‡ï¼Œæ­¤æ—¶æŒ‡å‘çš„æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„Effectå‡½æ•°
6. å°†å±æ€§å€¼ä¸å‰¯ä½œç”¨å‡½æ•°ç»‘å®šå…³ç³»å¹¶å­˜å‚¨
7. `activeEffect = null`æ–¹ä¾¿åç»­ä½¿ç”¨

å½“æˆ‘ä»¬æ›´æ–°äº†å“åº”å¼æ•°æ®ä¸­çš„å€¼åï¼Œç”±äºæˆ‘ä»¬å·²ç»ä¸º`ReactiveObject`è®¾ç½®äº†ä»£ç†æ‹¦æˆªæ“ä½œ`set`ï¼Œæ•…ä¼šåœ¨æˆ‘ä»¬è®¾ç½®è¯¥å¯¹è±¡å±æ€§å€¼æ—¶è‡ªåŠ¨è§¦å‘triggerå‡½æ•°

8. æ‰¾åˆ°å±æ€§å€¼ä¾èµ–çš„å‰¯ä½œç”¨å‡½æ•°
9. æ‰§è¡Œè¯¥å‰¯ä½œç”¨å‡½æ•°å®Œæˆè‡ªåŠ¨æ›´æ–°

æ ¸å¿ƒä»£ç å®ç°å¯¹åº”å›¾ç‰‡å¦‚ä¸‹ï¼š

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230204050757.png)

> [å‚è€ƒå›¾ç‰‡åŸæ–‡](https://juejin.cn/post/7145756356014768158)

### ç»“åˆæ¸²æŸ“æ¨¡å—

å“åº”å¼æ¨¡å—çš„æ›´æ–°æµç¨‹ç›¸ä¿¡å¤§å®¶å·²ç»ä¸é™Œç”Ÿäº†ï¼Œæ— éå°±æ˜¯æ›´æ”¹å“åº”å¼æ•°æ®åï¼Œè¢«ä»£ç†ä¸­çš„`set`ç­‰æ‹¦æˆªï¼Œç„¶åæ‰§è¡Œæ•°æ®å±æ€§ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ä»è€Œå®Œæˆå“åº”å¼æ›´æ–°ã€‚

æ¥ä¸‹æ¥ä¸»è¦ç»“åˆæ¸²æŸ“æ¨¡å—è°ˆè°ˆæ¡†æ¶æ˜¯å¦‚ä½•è®©ä¸€ä¸ªç»„ä»¶è¿›å…¥å“åº”å¼æ¨¡å—çš„ï¼Œç®€å•æ¥è¯´å°±æ˜¯**åˆå§‹åŒ–è¿‡ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„**ï¼š

*å‡†å¤‡ï¼Œé¦–å…ˆæ˜¯å“åº”å¼æ•°æ®å·²ç»å»ºç«‹ï¼Œå³æ¡†æ¶å·²ç»å¯¹è¯¥æ•°æ®å»ºç«‹äº†ä»£ç†ï¼Œå¹¶è®¾ç½®äº†å„ç§æ‹¦æˆªå™¨ã€‚æ­¤æ—¶å¦‚æœæˆ‘ä»¬è¯»å–æˆ–è€…æ“ä½œè¯¥å“åº”å¼æ•°æ®ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘ç›¸å…³å‡½æ•°*

![](https://oss.justin3go.com/blogs/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BB%93%E5%90%88%E6%B8%B2%E6%9F%93%E6%A8%A1%E5%9D%97%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B.png)

- æ€»çš„æ¥è¯´å°±æ˜¯åœ¨åˆå§‹åŒ–ç»„ä»¶æ˜¯ä¼šè°ƒç”¨æ¸²æŸ“æ¨¡å—
- ç„¶åå°±ä¼šè°ƒç”¨ä¸€äº›ï¼ˆä¸Šä¸‹æ–‡+æ¸²æŸ“æ¨¡å—ä¸­çš„å‡½æ•°ï¼‰ä½œä¸ºåç»­ç»„ä»¶çš„æ›´æ–°å‡½æ•°ï¼Œå³å‰¯ä½œç”¨å‡½æ•°ã€‚
- ç„¶åä¼ é€’ç»™å“åº”å¼æ¨¡å—è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œçœ‹çœ‹ä¸å“ªäº›å“åº”å¼æ•°æ®æœ‰å…³ï¼Œä»è€Œå»ºç«‹ä¾èµ–å…³ç³»ã€‚

### æ·±å…¥æºç 

ç¯‡å¹…æœ‰é™ï¼Œè¿™éƒ¨åˆ†å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œå¦‚ä¸‹ä¸ºä¸»è¦å‡½æ•°çš„æºç ä½ç½®ç´¢å¼•ï¼š

- [createGetter](https://github.com/vuejs/core/blob/main/packages/reactivity/src/baseHandlers.ts#L94)
- [createSetter](https://github.com/vuejs/core/blob/main/packages/reactivity/src/baseHandlers.ts#L161)
- [track](https://github.com/vuejs/core/blob/main/packages/reactivity/src/effect.ts#L213)
- [trigger](https://github.com/vuejs/core/blob/main/packages/reactivity/src/effect.ts#L263)

### å…¶ä»–

å…³äºå“åº”å¼æ¨¡å—ï¼Œé™¤äº†ä¸Šè¿°ä¸»è¦å·¥ä½œæµç¨‹ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–ç»å…¸é—®é¢˜ï¼Œè¿™é‡Œè¿›è¡Œä¸€ä¸ªåŸºæœ¬æ±‡æ€»ï¼ˆè¯¥éƒ¨åˆ†ç›¸å…³é“¾æ¥ä»…ä½œå‚è€ƒï¼Œç¬”è€…ä»…ç²—ç•¥é˜…è¯»ç¬¦åˆé—®é¢˜æè¿°å³å¯ï¼‰ï¼š

|é—®é¢˜æ ‡é¢˜|ç®€è¿°|æ·±å…¥é˜…è¯»é“¾æ¥|
|-|-|-|
|effectStack|effectå‡½æ•°å†…éƒ¨åµŒå¥—effectå‡½æ•°æ—¶ï¼ŒactiveEffectå˜é‡ä¼šè¢«è¦†ç›–æ¶ˆå¤±ï¼Œæ•…æ·»åŠ ä¸€ä¸ªæ ˆè¿›è¡Œä¿å­˜|[é˜…è¯»é“¾æ¥](https://juejin.cn/post/7100778134240231437)|
|computed|effect.lazyé€‰é¡¹ + getterå®ç°ï¼Œå¯ç¼“å­˜ï¼Œéœ€è¦æ—¶æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œè€Œéå“åº”å¼æ•°æ®ä¸€å˜åŒ–å°±ç›´æ¥æ‰§è¡Œ|[é˜…è¯»é“¾æ¥](https://juejin.cn/post/7085524315063451684)|
|watch|effect.scheduleré€‰é¡¹æ§åˆ¶æ‰§è¡Œæ—¶æœº+ä¿å­˜æ—§å€¼|[é˜…è¯»é“¾æ¥](https://juejin.cn/post/7087748001208205343)|
|æ›´å…¨é¢çš„ç›‘æµ‹æœºåˆ¶|ä½¿ç”¨proxyå„ç§æ‹¦æˆªå™¨å¤„ç†ä¸€äº›è¾¹ç•Œæ¡ä»¶ï¼Œæ¯”å¦‚æ‹¦æˆª`.length`ã€`in`...ç­‰|[é˜…è¯»é“¾æ¥](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/ownKeys)|
|ref|ç®€å•ç†è§£ä¸ºreactiveçš„`.value`å±æ€§|[é˜…è¯»é“¾æ¥](https://vuejsdevelopers.com/2022/06/01/ref-vs-reactive/)|

## æ‰©å±•é—®é¢˜

### 1. ä¸ºä»€ä¹ˆVue3çš„æ¨¡æ¿æ ¹ç»“ç‚¹å¯ä»¥ä¸ºå¤šç»“ç‚¹

-   Vue2åœ¨ç»„ä»¶ä¸­åªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ã€‚
-   Vue3åœ¨ç»„ä»¶å¯ä»¥æ‹¥æœ‰å¤šä¸ªæ ¹èŠ‚ç‚¹ã€‚

åœ¨æ¸²æŸ“å‡½æ•°å±‚é¢æ”¯æŒ`Fragment`ï¼Œå…¶æœ¬èº«ä¸ä¼šæ¸²æŸ“ä»»ä½•å†…å®¹ï¼Œå¯ä»¥ç†è§£ä¸ºåœ¨å¤šä¸ªæ ¹èŠ‚ç‚¹å¤–åŒ…è£¹ä¸€å±‚`Fragment`å°±å¯ä»¥å¤„ç†äº†ã€‚

[`processFragment()`](https://github.com/vuejs/core/blob/main/packages/runtime-core/src/renderer.ts#L400)

==æ¬¢è¿è¡¥å……...==

## æœ€å

ä¸€ç›´éƒ½æƒ³å†™ä¸€ç¯‡æ–‡ç« å°†æ‰€å­¦çš„VueåŸç†éƒ¨åˆ†ä¸²èµ·æ¥ï¼Œéš¾åº¦ç¡®å®è¾ƒå¤§ï¼Œè‡ªå·±ä¹Ÿä¸€æ‹–å†æ‹–ã€‚å¦‚ä½•åšåˆ°è¯¦ç•¥å¾—å½“ï¼Œå¦‚ä½•æ·±å…¥æµ…å‡ºç­‰ç­‰ã€‚åœ¨æ¢³ç†è„‰ç»œã€ä¹¦å†™æ–‡ç« æ–¹é¢è‡ªå·±è¿˜æœ‰å¾ˆå¤šåœ°æ–¹å€¼å¾—åŠ å¼ºã€‚

- æœ€ååœ¨è¿™é‡Œæ¬¢è¿è¡¥å……ï¼›
- ç²¾åŠ›æœ‰é™ï¼Œé•¿æ–‡éš¾å…æœ‰è¯¯ï¼Œå¦‚æœé”™è¯¯ï¼Œä¹Ÿå¸Œæœ›ä½ èƒ½å‹å–„æŒ‡å‡ºğŸ¤ï¼›
- ç å­—ä¸æ˜“ï¼Œå¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè¿˜æœ›ä¸åğŸ‘ã€‚

![](https://oss.justin3go.com/blogs/Pasted%20image%2020230203012605.png)

## å‚è€ƒ

- [Vueå®˜ç½‘-è¿›é˜¶ä¸»é¢˜](https://cn.vuejs.org/guide/extras/ways-of-using-vue.html)
- [ä»åŸç†å’Œæºç ç†è§£Vue3çš„å“åº”å¼æœºåˆ¶](https://juejin.cn/post/7145756356014768158)
- [vue3.0 å“åº”å¼åŸç†(è¶…è¯¦ç»†)](https://juejin.cn/post/6858899262596448270)
- [VueJSè®¾è®¡ä¸å®ç°](https://www.ituring.com.cn/book/2953)
- [Vue 3 Deep Dive with Evan You](https://www.vuemastery.com/courses/vue3-deep-dive-with-evan-you/vue3-overview)
- [Vue æ–‡ä»¶æ˜¯å¦‚ä½•è¢«è½¬æ¢å¹¶æ¸²æŸ“åˆ°é¡µé¢çš„ï¼Ÿ](https://juejin.cn/post/7115014433109180423)
- [Vue 3.2 æºç ç³»åˆ—ï¼š04-æœ‰ç‚¹éš¾çš„ã€Šæœ€æ–° diff ç®—æ³•è¯¦è§£ã€‹](https://juejin.cn/post/7190726242042118200)
- [ç»†è¯´ Vue.js 3.2 å…³äºå“åº”å¼éƒ¨åˆ†çš„ä¼˜åŒ–](https://juejin.cn/post/6995732683435278344)

